const mongoose = require('mongoose');

const giesswerkstoffSchema = new mongoose.Schema({
  bezeichnung: {
    type: String,
    required: true,
    unique: true,
    trim: true
  },
  typ: {
    type: String,
    required: true,
    enum: ['gips', 'beton', 'epoxidharz', 'polyurethan', 'silikon', 'wachs', 'ton', 'keramikschlicker', 'sonstiges'],
    default: 'gips'
  },
  kategorie: {
    type: String,
    enum: ['rohstoff', 'fertigmischung', 'zusatzstoff', 'haertungsagent', 'pigment', 'release_agent'],
    default: 'rohstoff'
  },
  
  // Physikalische Eigenschaften
  konsistenz: {
    type: String,
    enum: ['pulver', 'fluessig', 'pastoes', 'fest', 'gel'],
    default: 'pulver'
  },
  farbe: {
    type: String,
    default: 'weiß',
    trim: true
  },
  dichte: {
    type: Number,
    min: 0,
    default: null // g/cm³
  },
  
  // Lager- und Bestandsdaten
  aktuellerBestand: {
    type: Number,
    required: true,
    default: 0,
    min: 0
  },
  einheit: {
    type: String,
    required: true,
    enum: ['kg', 'g', 'l', 'ml', 'stueck', 'packung'],
    default: 'g'
  },
  mindestbestand: {
    type: Number,
    required: true,
    default: 1000,
    min: 0
  },
  maximalbestand: {
    type: Number,
    default: 100,
    min: 0
  },
  
  // Wirtschaftliche Daten
  einkaufspreis: {
    type: Number,
    required: true,
    min: 0
  },
  preisProEinheit: {
    type: Number,
    required: true,
    min: 0
  },
  waehrung: {
    type: String,
    default: 'EUR',
    enum: ['EUR', 'USD', 'CHF', 'GBP']
  },
  lieferant: {
    type: String,
    trim: true,
    default: ''
  },
  artikelnummer: {
    type: String,
    trim: true,
    default: ''
  },
  produktlink: {
    type: String,
    trim: true,
    default: ''
  },
  
  bild: {
    type: String,
    default: '',
    trim: true
  },
  
  // Legacy field for backward compatibility - might exist as string in old data
  zusatzstoffe: {
    type: mongoose.Schema.Types.Mixed,
    default: ''
  },
  
  // Mischungseigenschaften
  mischverhaeltnisse: [{
    partnerStoff: {
      type: String,
      trim: true
    },
    verhaeltnisBasis: {
      type: Number,
      min: 0,
      default: 1
    },
    verhaeltnisPartner: {
      type: Number, 
      min: 0,
      default: 1
    },
    bemerkung: {
      type: String,
      trim: true,
      default: ''
    }
  }],
  
  // Standard-Mischverhältnis (häufigste Verwendung)
  standardMischung: {
    type: mongoose.Schema.Types.Mixed,
    default: function() {
      return {
        wasserVerhaeltnis: null,
        zusatzstoffe: []
      };
    }
  },
  
  // Verarbeitungszeiten
  verarbeitungszeit: {
    type: mongoose.Schema.Types.Mixed,
    default: function() {
      return {
        topfzeit: null,
        haertungszeit: null,
        vollhaertung: null
      };
    }
  },
  
  // Qualitätseigenschaften
  eigenschaften: {
    type: mongoose.Schema.Types.Mixed,
    default: function() {
      return {
        haerte: 'mittel',
        oberflaeche: 'glatt',
        schrumpf: null,
        wasserfest: false,
        uv_bestaendig: false
      };
    }
  },
  
  // Lagerung und Haltbarkeit
  lagerung: {
    type: mongoose.Schema.Types.Mixed,
    default: function() {
      return {
        temperaturMin: null,
        temperaturMax: null,
        luftfeuchtigkeit: '',
        haltbarkeitMonate: 12,
        lagerort: ''
      };
    }
  },
  
  // Sicherheit und Gesundheit
  sicherheit: {
    type: mongoose.Schema.Types.Mixed,
    default: function() {
      return {
        gefahrenstoff: false,
        hPictogramme: [],
        rSaetze: [],
        sSaetze: [],
        schutzausruestung: ''
      };
    }
  },
  
  // Mischverhältnis-Konfiguration für automatische Ausbuchung
  mischkonfiguration: {
    berechnungsFaktor: {
      type: Number,
      default: 1.5,
      min: 1.0,
      max: 10.0
    },
    schwundProzent: {
      type: Number,
      default: 5,
      min: 0,
      max: 50
    },
    zusaetzlichesMaterial: {
      type: [{
        bezeichnung: {
          type: String,
          required: true
        },
        faktor: {
          type: Number,
          required: true,
          min: 0,
          max: 10,
          default: 0
        },
        einheit: {
          type: String,
          default: 'g'
        }
      }],
      default: []
    }
  },
  
  // Verfügbarkeit und Status
  verfuegbar: {
    type: Boolean,
    default: true
  },
  qualitaetsgeprueft: {
    type: Boolean,
    default: true
  },
  chargeNummer: {
    type: String,
    default: '',
    trim: true
  },
  ablaufdatum: {
    type: Date,
    default: null
  },
  
  // Verwendungsstatistik
  verbrauchsstatistik: {
    type: mongoose.Schema.Types.Mixed,
    default: function() {
      return {
        letzteVerwendung: null,
        verwendungenGesamt: 0,
        durchschnittProVerwendung: 0
      };
    }
  },
  
  // Beschreibung und Notizen
  beschreibung: {
    type: String,
    default: '',
    trim: true
  },
  anwendungshinweise: {
    type: String,
    default: '',
    trim: true
  },
  besonderheiten: {
    type: String,
    default: '',
    trim: true
  },
  notizen: {
    type: String,
    default: '',
    trim: true
  },
  
  // Tags für bessere Suchbarkeit
  tags: [{
    type: String,
    trim: true
  }]
}, {
  timestamps: true,
  toJSON: { virtuals: true },
  toObject: { virtuals: true }
});

// Virtuelle Felder für berechnete Werte
giesswerkstoffSchema.virtual('bestandsStatus').get(function() {
  if (this.aktuellerBestand <= 0) return 'leer';
  if (this.aktuellerBestand <= this.mindestbestand) return 'niedrig';
  if (this.aktuellerBestand >= this.maximalbestand) return 'uebervoll';
  return 'normal';
});

giesswerkstoffSchema.virtual('kostenAktuellerBestand').get(function() {
  return (this.aktuellerBestand * this.preisProEinheit).toFixed(2);
});

giesswerkstoffSchema.virtual('istAbgelaufen').get(function() {
  return this.ablaufdatum ? new Date() > this.ablaufdatum : false;
});

giesswerkstoffSchema.virtual('tageHaltbar').get(function() {
  if (!this.ablaufdatum) return null;
  const heute = new Date();
  const differenz = this.ablaufdatum - heute;
  return Math.ceil(differenz / (1000 * 60 * 60 * 24));
});

giesswerkstoffSchema.virtual('bestellmenge').get(function() {
  const fehlmenge = this.maximalbestand - this.aktuellerBestand;
  return Math.max(0, fehlmenge);
});

// Indices für Performance
giesswerkstoffSchema.index({ typ: 1, kategorie: 1 });
giesswerkstoffSchema.index({ verfuegbar: 1, aktuellerBestand: 1 });
giesswerkstoffSchema.index({ lieferant: 1, artikelnummer: 1 });
giesswerkstoffSchema.index({ tags: 1 });
giesswerkstoffSchema.index({ ablaufdatum: 1 });

// Pre-save Middleware
giesswerkstoffSchema.pre('save', function(next) {
  // Tags bereinigen
  if (this.tags) {
    this.tags = this.tags.map(tag => tag.toLowerCase().trim()).filter(tag => tag.length > 0);
  }
  
  // Preisberechnung aktualisieren
  if (this.einkaufspreis && this.aktuellerBestand > 0) {
    // Hier könnte komplexere Logik stehen
  }
  
  // Ensure lagerung is an object before accessing properties
  const lagerung = typeof this.lagerung === 'object' ? this.lagerung : {};
  
  // Ablaufdatum setzen wenn nicht vorhanden
  if (!this.ablaufdatum && lagerung.haltbarkeitMonate) {
    const heute = new Date();
    this.ablaufdatum = new Date(heute.setMonth(heute.getMonth() + lagerung.haltbarkeitMonate));
  }
  
  next();
});

// Statische Methoden
giesswerkstoffSchema.statics.findVerfuegbare = function() {
  return this.find({ verfuegbar: true, aktuellerBestand: { $gt: 0 } });
};

giesswerkstoffSchema.statics.findNiedrigerBestand = function() {
  return this.find({ 
    $where: 'this.aktuellerBestand <= this.mindestbestand',
    verfuegbar: true 
  });
};

giesswerkstoffSchema.statics.findByTyp = function(typ) {
  return this.find({ typ: typ, verfuegbar: true });
};

giesswerkstoffSchema.statics.findAbgelaufen = function() {
  return this.find({ 
    ablaufdatum: { $lt: new Date() },
    verfuegbar: true 
  });
};

giesswerkstoffSchema.statics.findBaldAbgelaufen = function(tage = 30) {
  const checkDate = new Date();
  checkDate.setDate(checkDate.getDate() + tage);
  return this.find({ 
    ablaufdatum: { $lte: checkDate, $gte: new Date() },
    verfuegbar: true 
  });
};

// Instance-Methoden
giesswerkstoffSchema.methods.verbrauchHinzufuegen = function(menge, zweck = '') {
  this.aktuellerBestand = Math.max(0, this.aktuellerBestand - menge);
  
  // Ensure verbrauchsstatistik is an object
  if (typeof this.verbrauchsstatistik !== 'object') {
    this.verbrauchsstatistik = {
      letzteVerwendung: null,
      verwendungenGesamt: 0,
      durchschnittProVerwendung: 0
    };
  }
  
  this.verbrauchsstatistik.letzteVerwendung = new Date();
  this.verbrauchsstatistik.verwendungenGesamt += 1;
  
  // Durchschnitt neu berechnen
  const gesamtVerbrauch = this.verbrauchsstatistik.durchschnittProVerwendung * (this.verbrauchsstatistik.verwendungenGesamt - 1) + menge;
  this.verbrauchsstatistik.durchschnittProVerwendung = gesamtVerbrauch / this.verbrauchsstatistik.verwendungenGesamt;
  
  return this.save();
};

giesswerkstoffSchema.methods.bestandAuffuellen = function(menge, neuerPreis = null) {
  this.aktuellerBestand += menge;
  if (neuerPreis !== null) {
    this.preisProEinheit = neuerPreis;
  }
  return this.save();
};

giesswerkstoffSchema.methods.getMischungsInfo = function(gewuenschteMenge = 1) {
  const info = {
    basis: this.bezeichnung,
    menge: gewuenschteMenge,
    einheit: this.einheit
  };
  
  // Ensure standardMischung is an object
  const standardMischung = typeof this.standardMischung === 'object' ? this.standardMischung : {};
  
  if (standardMischung.wasserVerhaeltnis) {
    info.wasser = {
      menge: gewuenschteMenge * standardMischung.wasserVerhaeltnis,
      einheit: this.einheit === 'kg' ? 'l' : 'ml'
    };
  }
  
  if (standardMischung.zusatzstoffe && Array.isArray(standardMischung.zusatzstoffe) && standardMischung.zusatzstoffe.length > 0) {
    info.zusatzstoffe = standardMischung.zusatzstoffe.map(zusatz => ({
      name: zusatz.bezeichnung,
      menge: this.berechneMengeFuerZusatz(gewuenschteMenge, zusatz),
      einheit: zusatz.einheit
    }));
  }
  
  return info;
};

giesswerkstoffSchema.methods.berechneMengeFuerZusatz = function(basisMenge, zusatz) {
  switch (zusatz.einheit) {
    case 'prozent':
      return (basisMenge * zusatz.anteil) / 100;
    case 'gramm_pro_kg':
      return zusatz.anteil * (this.einheit === 'kg' ? basisMenge : basisMenge / 1000);
    case 'ml_pro_l':
      return zusatz.anteil * (this.einheit === 'l' ? basisMenge : basisMenge / 1000);
    default:
      return zusatz.anteil;
  }
};

module.exports = mongoose.model('Giesswerkstoff', giesswerkstoffSchema);