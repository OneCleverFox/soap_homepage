import React, { useState, useEffect, useCallback } from 'react';
import {
  Container,
  Typography,
  Box,
  Card,
  CardContent,
  Grid,
  Chip,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Alert,
  CircularProgress,
  IconButton,
  TextField,
  Select,
  MenuItem,
  FormControl,
  InputLabel,
  Snackbar,
  Badge,
  Tabs,
  Tab,
  Fab,
  List,
  ListItem,
  ListItemText,
  ListItemIcon,
  ListItemSecondaryAction,
  useMediaQuery,
  useTheme
} from '@mui/material';
import {
  FilterList,
  Search,
  LocalShipping,
  Timeline,
  Cancel,
  Sort,
  ViewList,
  Receipt as InvoiceIcon,
  Email as EmailIcon,
  Download as DownloadIcon,
  Send as SendIcon,
  Dashboard,
  Refresh,
  Euro,
  Warning,
  Email,
  ContentCopy,
  Edit as EditIcon,
  HelpOutline
} from '@mui/icons-material';
import { format } from 'date-fns';
import { de } from 'date-fns/locale';
import api from '../services/api';
import BestellverwaltungHilfe from './BestellverwaltungHilfe';

const AdminOrdersManagement = () => {
  // Theme und Responsive
  const theme = useTheme();
  
  // State Management
  const [orders, setOrders] = useState([]);
  const [inquiries, setInquiries] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [selectedInquiry, setSelectedInquiry] = useState(null);
  const [dialogOpen, setDialogOpen] = useState(false);
  const [inquiryDialogOpen, setInquiryDialogOpen] = useState(false);
  const [trackingDialog, setTrackingDialog] = useState(false);
  const [hilfeOpen, setHilfeOpen] = useState(false);
  
  // Filter & Sortierung
  const [filters, setFilters] = useState({
    status: 'pending', // pending = alle offenen
    sortBy: 'oldest',
    searchTerm: '',
    dateRange: 'all'
  });
  const [stats, setStats] = useState({});
  const [tabValue, setTabValue] = useState(0);
  
  // Tracking-Daten
  const [trackingData, setTrackingData] = useState({
    sendungsnummer: '',
    anbieter: 'dhl',
    notiz: ''
  });

  // Status-Konfiguration entsprechend dem Workflow
  const statusConfig = {
    anfrage: {
      label: 'Anfrage',
      color: 'info',
      priority: 0,
      action: 'Anfrage bearbeiten',
      description: 'Kundenanfrage - Warten auf Admin-Entscheidung'
    },
    neu: { 
      label: 'Neu', 
      color: 'warning', 
      priority: 1, 
      action: 'Zahlung prÃ¼fen / BestÃ¤tigen',
      description: 'Bestellung eingegangen, Zahlung noch ausstehend'
    },
    bezahlt: { 
      label: 'Bezahlt', 
      color: 'success', 
      priority: 2, 
      action: 'Jetzt bestÃ¤tigen',
      description: 'PayPal-Zahlung erfolgreich, bereit zur BestÃ¤tigung'
    },
    bestaetigt: { 
      label: 'BestÃ¤tigt', 
      color: 'primary', 
      priority: 3, 
      action: 'Verpacken',
      description: 'Bestellung bestÃ¤tigt, bereit zur Verpackung'
    },
    abgelehnt: { 
      label: 'Abgelehnt - RÃ¼ckerstattung', 
      color: 'error', 
      priority: 10, 
      action: 'RÃ¼ckerstattung bearbeiten',
      description: 'Bestellung abgelehnt, RÃ¼ckerstattung muss bearbeitet werden'
    },
    verpackt: { 
      label: 'Verpackt', 
      color: 'info', 
      priority: 4, 
      action: 'Tracking-Nummer eingeben',
      description: 'Paket verpackt, bereit zum Versand'
    },
    verschickt: { 
      label: 'Verschickt', 
      color: 'secondary', 
      priority: 5, 
      action: 'DHL-Updates Ã¼berwachen',
      description: 'Paket versendet, Tracking aktiv'
    },
    zugestellt: { 
      label: 'Zugestellt', 
      color: 'success', 
      priority: 6, 
      action: 'Abgeschlossen',
      description: 'Paket erfolgreich zugestellt'
    },
    storniert: { 
      label: 'Storniert', 
      color: 'error', 
      priority: 0, 
      action: 'Abgeschlossen',
      description: 'Bestellung storniert'
    }
  };

  const carrierOptions = [
    { value: 'dhl', label: 'DHL', icon: 'ðŸ“¦' },
    { value: 'hermes', label: 'Hermes', icon: 'ðŸšš' },
    { value: 'ups', label: 'UPS', icon: 'ðŸ“®' },
    { value: 'dpd', label: 'DPD', icon: 'ðŸš›' },
    { value: 'gls', label: 'GLS', icon: 'ðŸ“«' },
    { value: 'tnt', label: 'TNT', icon: 'ðŸš' }
  ];

  // Data Loading mit Pull-to-Refresh Support
  const [refreshing, setRefreshing] = useState(false);
  
  const loadOrders = useCallback(async (isRefresh = false) => {
    try {
      if (isRefresh) {
        setRefreshing(true);
      } else {
        setLoading(true);
      }
      console.log('ðŸ”„ Lade Bestellungen mit Filtern:', filters);
      
      const queryParams = new URLSearchParams();
      if (filters.status !== 'all') {
        if (filters.status === 'pending') {
          // Alle zu bearbeitenden Bestellungen (inkl. abgelehnt fÃ¼r RÃ¼ckerstattung)
          queryParams.append('status', 'neu,bezahlt,bestaetigt,verpackt,abgelehnt');
        } else {
          queryParams.append('status', filters.status);
        }
      }
      queryParams.append('sortBy', filters.sortBy);
      queryParams.append('limit', '200'); // Mehr Bestellungen fÃ¼r "alle"

      // Verschiedene Endpunkte je nach Filter
      const endpoint = filters.status === 'all' 
        ? `/orders/admin/all?${queryParams}`
        : `/orders/admin/pending?${queryParams}`;
      
      console.log('ðŸ“¡ API-Aufruf:', endpoint);

      const response = await api.get(endpoint);
      console.log('ðŸ“Š Response Status:', response.status);
      
      const data = response.data;
      console.log('ðŸ“¦ Response Data:', data);
      
      if (data.success) {
        // Verschiedene API-Routen haben unterschiedliche Datenstrukturen
        let ordersData, statsData;
        
        if (filters.status === 'all') {
          // /api/orders/admin/all Route
          ordersData = data.data?.orders || data.orders || [];
          statsData = data.data?.stats || data.stats || {};
        } else {
          // /api/orders/admin/pending Route
          ordersData = data.data?.orders || data.orders || [];
          statsData = data.data?.stats || data.stats || {};
        }
        
        console.log(`âœ… ${ordersData.length} Bestellungen geladen`);
        setOrders(ordersData);
        setStats(statsData);
        setError(''); // Clear any previous errors
        if (isRefresh) {
          setSuccess('ðŸ”„ Bestellungen erfolgreich aktualisiert');
        }
      } else {
        console.error('âŒ API Fehler:', data.message);
        setError(data.message);
      }
    } catch (err) {
      console.error('âŒ API Fehler:', err);
      const errorMessage = err.response?.data?.message || err.message || 'Fehler beim Laden der Bestellungen';
      setError(errorMessage);
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  }, [filters]);

  // Anfragen laden
  const loadInquiries = useCallback(async () => {
    try {
      console.log('ðŸ”„ Lade Anfragen...');
      
      const response = await api.get('/inquiries/admin/all?status=pending&limit=50');
      console.log('ðŸ“Š Inquiries Response:', response);
      
      if (response.data.success) {
        const inquiriesData = response.data.inquiries || [];
        console.log(`âœ… ${inquiriesData.length} Anfragen geladen`);
        setInquiries(inquiriesData);
      }
    } catch (err) {
      console.error('âŒ Fehler beim Laden der Anfragen:', err);
      // Nicht kritisch, wenn Anfragen nicht geladen werden kÃ¶nnen
    }
  }, []);

  // Pull-to-refresh Handler fÃ¼r Mobile
  const handlePullToRefresh = useCallback(() => {
    loadOrders(true);
  }, [loadOrders]);

  useEffect(() => {
    loadOrders();
    loadInquiries();
  }, [loadOrders, loadInquiries]);

  // Actions
  const handleStatusUpdate = async (orderId, newStatus, note = '', versandData = null) => {
    try {
      const updatePayload = { 
        status: newStatus,
        notiz: note,
        bearbeiter: 'Admin'
      };

      // Versanddaten hinzufÃ¼gen wenn vorhanden (fÃ¼r "verschickt" Status)
      if (versandData) {
        updatePayload.versand = versandData;
      }

      const response = await api.put(`/orders/${orderId}/status`, updatePayload);

      const data = response.data;
      if (data.success) {
        const successMsg = versandData 
          ? `Status auf "Verschickt" aktualisiert - Sendungsnummer: ${versandData.sendungsnummer}`
          : `Status erfolgreich auf "${statusConfig[newStatus].label}" aktualisiert`;
        setSuccess(successMsg);
        loadOrders();
        setDialogOpen(false);
      } else {
        setError(data.message);
      }
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Fehler beim Aktualisieren';
      setError(errorMessage);
    }
  };

  // ðŸ“§ Bestellung bestÃ¤tigen mit E-Mail
  const handleConfirmOrder = async (orderId, note = '') => {
    try {
      setLoading(true);
      const response = await api.post(`/orders/${orderId}/confirm`, {
        notiz: note || `Bestellung bestÃ¤tigt am ${new Date().toLocaleString('de-DE')}`,
        bearbeiter: 'Admin'
      });

      const data = response.data;
      if (data.success) {
        setSuccess('âœ… Bestellung bestÃ¤tigt - BestÃ¤tigungs-E-Mail wurde versendet');
        loadOrders();
        setDialogOpen(false);
      } else {
        setError(data.message);
      }
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Fehler beim BestÃ¤tigen';
      setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };



  // ðŸ“§ Bestellung ablehnen mit E-Mail
  const handleRejectOrder = async (orderId, note = '', reason = null) => {
    try {
      setLoading(true);
      const response = await api.post(`/orders/${orderId}/reject`, {
        notiz: note || `Bestellung abgelehnt am ${new Date().toLocaleString('de-DE')}`,
        bearbeiter: 'Admin',
        reason: reason
      });

      const data = response.data;
      if (data.success) {
        setSuccess('âŒ Bestellung abgelehnt - Ablehnungs-E-Mail wurde versendet');
        loadOrders();
        setDialogOpen(false);
      } else {
        setError(data.message);
      }
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Fehler beim Ablehnen';
      setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  // Validierung fÃ¼r Tracking-Nummern verschiedener Lieferdienste
  const validateTrackingNumber = (trackingNumber, carrier) => {
    if (!trackingNumber || !carrier) return { isValid: false, message: 'Sendungsnummer und Anbieter sind erforderlich' };
    
    const trimmedNumber = trackingNumber.trim().toUpperCase();
    
    switch (carrier.toLowerCase()) {
      case 'dhl':
        // DHL: 10 Ziffern oder 3 Buchstaben + 12 Ziffern (z.B. JD123456789012)
        if (/^\d{10}$/.test(trimmedNumber)) {
          return { isValid: true, message: 'GÃ¼ltige DHL-Sendungsnummer' };
        } else if (/^[A-Z]{2,3}\d{12}$/.test(trimmedNumber)) {
          return { isValid: true, message: 'GÃ¼ltige DHL-Sendungsnummer' };
        } else {
          return { 
            isValid: false, 
            message: 'DHL-Sendungsnummer muss 10 Ziffern (z.B. 1234567890) oder 2-3 Buchstaben + 12 Ziffern (z.B. JD123456789012) enthalten' 
          };
        }
        
      case 'gls':
        // GLS: 8 Zeichen (Buchstaben+Ziffern) oder 11 Ziffern
        if (/^[A-Z0-9]{8}$/.test(trimmedNumber)) {
          return { isValid: true, message: 'GÃ¼ltige GLS-Sendungsnummer' };
        } else if (/^\d{11}$/.test(trimmedNumber)) {
          return { isValid: true, message: 'GÃ¼ltige GLS-Sendungsnummer' };
        } else {
          return { 
            isValid: false, 
            message: 'GLS-Sendungsnummer muss 8 Zeichen (Buchstaben+Ziffern, z.B. 56T89AS2) oder 11 Ziffern (z.B. 54478966532) enthalten' 
          };
        }
        
      case 'tnt':
        // TNT: 8 oder 9 Ziffern
        if (/^\d{8,9}$/.test(trimmedNumber)) {
          return { isValid: true, message: 'GÃ¼ltige TNT-Sendungsnummer' };
        } else {
          return { 
            isValid: false, 
            message: 'TNT-Sendungsnummer muss 8 oder 9 Ziffern enthalten (z.B. 598846521 oder 569984532)' 
          };
        }
        
      case 'dpd':
        // DPD: 10-14 Ziffern, optional ein Buchstabe am Ende
        if (/^\d{10,14}[A-Z]?$/.test(trimmedNumber)) {
          return { isValid: true, message: 'GÃ¼ltige DPD-Sendungsnummer' };
        } else {
          return { 
            isValid: false, 
            message: 'DPD-Sendungsnummer muss 10-14 Ziffern enthalten, optional mit einem Buchstaben am Ende (z.B. 1154565645 oder 12222335412365A)' 
          };
        }
        
      case 'ups':
        // UPS: 1Z + 6 Zeichen + 8 Ziffern oder andere Formate
        if (/^1Z[A-Z0-9]{6}\d{8}$/.test(trimmedNumber)) {
          return { isValid: true, message: 'GÃ¼ltige UPS-Sendungsnummer' };
        } else if (/^[A-Z0-9]{9,18}$/.test(trimmedNumber)) {
          return { isValid: true, message: 'GÃ¼ltige UPS-Sendungsnummer' };
        } else {
          return { 
            isValid: false, 
            message: 'UPS-Sendungsnummer: 1Z + 6 Zeichen + 8 Ziffern (z.B. 1Z12345E1234567890) oder 9-18 Zeichen' 
          };
        }
        
      case 'hermes':
        // Hermes: Flexibles Format, meist 8-16 Zeichen
        if (/^[A-Z0-9]{8,16}$/.test(trimmedNumber)) {
          return { isValid: true, message: 'GÃ¼ltige Hermes-Sendungsnummer' };
        } else {
          return { 
            isValid: false, 
            message: 'Hermes-Sendungsnummer muss 8-16 Zeichen (Buchstaben und Ziffern) enthalten' 
          };
        }
        
      default:
        // FÃ¼r andere Anbieter: Grundvalidierung
        if (/^[A-Z0-9]{6,20}$/.test(trimmedNumber)) {
          return { isValid: true, message: 'Sendungsnummer akzeptiert' };
        } else {
          return { 
            isValid: false, 
            message: 'Sendungsnummer muss 6-20 Zeichen (Buchstaben und Ziffern) enthalten' 
          };
        }
    }
  };

  const handleAddTracking = async () => {
    if (!trackingData.sendungsnummer) {
      setError('Sendungsnummer ist erforderlich');
      return;
    }

    // Validierung der Tracking-Nummer
    const validation = validateTrackingNumber(trackingData.sendungsnummer, trackingData.anbieter);
    if (!validation.isValid) {
      setError(validation.message);
      return;
    }

    try {
      const isEditing = selectedOrder.versand?.sendungsnummer;
      console.log('ðŸ“¦ Tracking bearbeiten fÃ¼r Bestellung:', selectedOrder._id);
      console.log('âœ… Validierung erfolgreich:', validation.message);
      
      const response = await api.put(`/orders/${selectedOrder._id}/tracking`, {
        ...trackingData,
        bearbeiter: 'Admin'
      });

      const data = response.data;
      if (data.success) {
        const successMsg = isEditing 
          ? `Tracking-Informationen aktualisiert - Sendungsnummer: ${trackingData.sendungsnummer}`
          : 'Tracking-Informationen hinzugefÃ¼gt - Status auf "verschickt" gesetzt';
        setSuccess(successMsg);
        setTrackingDialog(false);
        setTrackingData({ sendungsnummer: '', anbieter: 'dhl', notiz: '' });
        loadOrders(); // Reload to show updated status
      } else {
        setError(data.message);
      }
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Fehler beim Aktualisieren der Tracking-Daten';
      setError(errorMessage);
    }
  };

  // Anfrage-Handler
  const handleInquiryAction = async (inquiry, action) => {
    try {
      setLoading(true);
      const endpoint = action === 'accept' ? 'accept' : action === 'reject' ? 'reject' : 'archive';
      
      const response = await api.put(`/inquiries/${inquiry._id}/${endpoint}`, {
        bearbeiter: 'Admin',
        notiz: `Anfrage ${action === 'accept' ? 'angenommen' : action === 'reject' ? 'abgelehnt' : 'archiviert'} am ${new Date().toLocaleString('de-DE')}`
      });

      const data = response.data;
      if (data.success) {
        const actionText = action === 'accept' ? 'angenommen' : action === 'reject' ? 'abgelehnt' : 'archiviert';
        setSuccess(`âœ… Anfrage erfolgreich ${actionText}`);
        loadInquiries();
        setInquiryDialogOpen(false);
      } else {
        setError(data.message);
      }
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Fehler beim Bearbeiten der Anfrage';
      setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };



  // UI Helpers
  const getStatusChip = (status) => {
    const config = statusConfig[status] || statusConfig.neu;
    return (
      <Chip
        label={config.label}
        color={config.color}
        size="small"
        variant="filled"
      />
    );
  };

  const getNextAction = (order) => {
    const config = statusConfig[order.status] || statusConfig.neu;
    return config.action;
  };

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('de-DE', {
      style: 'currency',
      currency: 'EUR'
    }).format(amount);
  };

  const formatDate = (date) => {
    if (!date) return 'Nicht gesetzt';
    try {
      const dateObj = new Date(date);
      if (isNaN(dateObj.getTime())) return 'UngÃ¼ltiges Datum';
      return format(dateObj, 'dd.MM.yyyy HH:mm', { locale: de });
    } catch (error) {
      console.error('Fehler beim Formatieren des Datums:', date, error);
      return 'Formatfehler';
    }
  };

  const getOrderPriority = (order) => {
    if (!order.erstelltAm) return 'low';
    try {
      const orderDate = new Date(order.erstelltAm);
      if (isNaN(orderDate.getTime())) return 'low';
      
      const daysSinceOrder = Math.floor((Date.now() - orderDate.getTime()) / (1000 * 60 * 60 * 24));
      if (daysSinceOrder > 3) return 'high';
      if (daysSinceOrder > 1) return 'medium';
      return 'low';
    } catch (error) {
      console.error('Fehler beim Berechnen der BestellprioritÃ¤t:', order.erstelltAm, error);
      return 'low';
    }
  };

  // Berechnet die Tage seit der letzten StatusÃ¤nderung
  const getDaysSinceLastStatusChange = (order) => {
    try {
      // PrÃ¼fe zunÃ¤chst das statusVerlauf Array
      if (order.statusVerlauf && Array.isArray(order.statusVerlauf) && order.statusVerlauf.length > 0) {
        // Finde die neueste StatusÃ¤nderung
        const latestStatusChange = order.statusVerlauf
          .filter(entry => entry.zeitpunkt) // Nur EintrÃ¤ge mit gÃ¼ltigem Zeitpunkt
          .sort((a, b) => new Date(b.zeitpunkt) - new Date(a.zeitpunkt))[0];
        
        if (latestStatusChange) {
          const statusDate = new Date(latestStatusChange.zeitpunkt);
          if (!isNaN(statusDate.getTime())) {
            return Math.floor((Date.now() - statusDate.getTime()) / (1000 * 60 * 60 * 24));
          }
        }
      }
      
      // Fallback: verwende erstelltAm wenn kein statusVerlauf vorhanden ist
      if (order.erstelltAm) {
        const orderDate = new Date(order.erstelltAm);
        if (!isNaN(orderDate.getTime())) {
          return Math.floor((Date.now() - orderDate.getTime()) / (1000 * 60 * 60 * 24));
        }
      }
      
      // ZusÃ¤tzlicher Fallback: bestelldatum
      if (order.bestelldatum) {
        const orderDate = new Date(order.bestelldatum);
        if (!isNaN(orderDate.getTime())) {
          return Math.floor((Date.now() - orderDate.getTime()) / (1000 * 60 * 60 * 24));
        }
      }
      
      return 0;
    } catch (error) {
      console.error('Fehler beim Berechnen der Tage seit letzter StatusÃ¤nderung:', error);
      return 0;
    }
  };

  const filteredOrders = orders.filter(order => {
    if (filters.searchTerm) {
      const searchLower = filters.searchTerm.toLowerCase();
      
      // Erweiterte Suche Ã¼ber alle relevanten Felder
      const searchableFields = [
        // Bestelldaten
        order.bestellnummer,
        order.kundennummer || '',
        
        // Kundendaten  
        order.besteller.vorname,
        order.besteller.nachname,
        order.besteller.email,
        order.besteller.telefon || '',
        
        // Adressdaten
        order.lieferadresse?.strasse || '',
        order.lieferadresse?.stadt || '',
        order.lieferadresse?.plz || '',
        order.rechnungsadresse?.strasse || '',
        order.rechnungsadresse?.stadt || '',
        order.rechnungsadresse?.plz || '',
        
        // Versanddaten
        order.versand?.sendungsnummer || '',
        order.versand?.anbieter || '',
        
        // Artikeldaten
        ...(order.artikel || []).map(artikel => 
          `${artikel.name || ''} ${artikel.kategorie || ''} ${artikel.beschreibung || ''}`
        ),
        
        // Status und Notizen
        order.status || '',
        order.notizen || ''
      ];
      
      return searchableFields.some(field => 
        field.toString().toLowerCase().includes(searchLower)
      );
    }
    return true;
  });

  // Anfragen als "Orders" fÃ¼r einheitliche Darstellung umwandeln
  const inquiriesAsOrders = inquiries.map(inquiry => ({
    _id: inquiry._id,
    bestellnummer: inquiry.inquiryId,
    status: 'anfrage',
    besteller: {
      vorname: inquiry.customer.name.split(' ')[0] || '',
      nachname: inquiry.customer.name.split(' ').slice(1).join(' ') || '',
      email: inquiry.customer.email
    },
    artikel: inquiry.items.map(item => ({
      name: item.name,
      menge: item.quantity,
      preis: item.price
    })),
    preise: {
      gesamtsumme: inquiry.total
    },
    erstelltAm: inquiry.createdAt,
    kundennummer: inquiry.customer.id,
    rechnungsadresse: inquiry.rechnungsadresse,
    lieferadresse: inquiry.lieferadresse,
    notizen: inquiry.customerNote || '',
    inquiryData: inquiry // Original-Anfrage-Daten fÃ¼r Details
  }));

  // Kombinierte Liste: Bestellungen + Anfragen
  const combinedItems = [...filteredOrders, ...inquiriesAsOrders];

  // Tab-Content
  const getTabContent = () => {
    switch (tabValue) {
      case 0:
        return <OrdersGrid />;
      case 1:
        return <OrdersTable />;
      case 2:
        return <OrdersDashboard />;
      default:
        return <OrdersGrid />;
    }
  };

  // Orders Grid View
  const OrdersGrid = () => (
    <Grid container spacing={2}>
      {combinedItems.map((order) => {
        const priority = getOrderPriority(order);
        const daysSince = getDaysSinceLastStatusChange(order);
        const shouldHighlight = daysSince > 3 && 
          !['rÃ¼ckerstattung', 'rueckerstattung', 'erledigt', 'zugestellt', 'abgelehnt'].includes(order.status?.toLowerCase());
        
        const badgeColor = shouldHighlight && daysSince > 3 ? 'error' : daysSince > 1 ? 'warning' : 'success';

        return (
          <Grid item xs={12} md={6} lg={4} key={order._id}>
            <Card
              elevation={priority === 'high' || order.status === 'abgelehnt' ? 4 : 1}
              sx={{
                border: order.status === 'abgelehnt' ? '3px solid #d32f2f' : 
                       priority === 'high' ? '2px solid #f44336' : 'none',
                backgroundColor: order.status === 'abgelehnt' ? '#ffebee' : 'inherit',
                cursor: 'pointer',
                '&:hover': { elevation: 3 }
              }}
              onClick={() => {
                if (order.type === 'inquiry') {
                  setSelectedInquiry(order);
                  setInquiryDialogOpen(true);
                } else {
                  setSelectedOrder(order);
                  setDialogOpen(true);
                }
              }}
            >
              <CardContent>
                <Box display="flex" justifyContent="space-between" alignItems="start" mb={2}>
                  <Typography variant="h6" component="div" sx={{ fontWeight: 'bold' }}>
                    {order.bestellnummer}
                  </Typography>
                  <Badge
                    badgeContent={getDaysSinceLastStatusChange(order)}
                    color={badgeColor}
                    sx={{ '& .MuiBadge-badge': { fontSize: '0.75rem' } }}
                  >
                    <Chip size="small" label="Tage" />
                  </Badge>
                </Box>

                <Box display="flex" alignItems="center" gap={1} mb={1}>
                  {getStatusChip(order.status)}
                  <Typography variant="body2" color="text.secondary">
                    {getNextAction(order)}
                  </Typography>
                </Box>

                <Typography variant="body2" sx={{ mb: 1, fontWeight: 'medium' }}>
                  {order.besteller.vorname} {order.besteller.nachname}
                </Typography>

                <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                  {order.besteller.email}
                </Typography>

                <Box display="flex" justifyContent="space-between" alignItems="center" mt={2}>
                  <Typography variant="h6" color="primary">
                    {formatCurrency(order.preise?.gesamtsumme || 0)}
                  </Typography>
                  <Typography variant="caption" color="text.secondary">
                    {formatDate(order.erstelltAm)}
                  </Typography>
                </Box>

                {order.versand?.sendungsnummer && (
                  <Chip
                    label={`ðŸ“¦ ${order.versand.sendungsnummer}`}
                    size="small"
                    variant="outlined"
                    sx={{ mt: 1 }}
                  />
                )}

                {/* Spezielle Anzeige fÃ¼r abgelehnte Bestellungen */}
                {order.status === 'abgelehnt' && (
                  <Alert severity="error" sx={{ mt: 1, mb: 1 }}>
                    <Typography variant="body2" sx={{ fontWeight: 'bold' }}>
                      ðŸ’° RÃ¼ckerstattung erforderlich
                    </Typography>
                    <Typography variant="caption" display="block">
                      <strong>Betrag:</strong> {formatCurrency(order.preise?.gesamtsumme || 0)}
                    </Typography>
                    <Typography variant="caption" display="block">
                      <strong>An:</strong> {order.besteller.email}
                    </Typography>
                    <Typography variant="caption" display="block">
                      <strong>Via:</strong> {order.zahlung?.methode?.toUpperCase() || 'UNBEKANNT'}
                      {order.zahlung?.methode === 'paypal' && (
                        <Chip 
                          label="PayPal" 
                          size="small" 
                          sx={{ ml: 1, bgcolor: '#0070ba', color: 'white', fontSize: '0.65rem', height: '16px' }} 
                        />
                      )}
                    </Typography>
                  </Alert>
                )}

                <Box display="flex" gap={1} mt={2}>
                  {/* RÃ¼ckerstattungs-Button fÃ¼r abgelehnte Bestellungen */}
                  {order.status === 'abgelehnt' && (
                    <Box display="flex" gap={1} flexWrap="wrap">
                      {/* Status der RÃ¼ckerstattung - nur bei erfolgreicher PayPal-RÃ¼ckerstattung */}
                      {order.rueckerstattung?.status === 'erfolgreich' ? (
                        <Chip
                          label={`âœ… PayPal-RÃ¼ckerstattung erledigt`}
                          color="success"
                          size="small"
                        />
                      ) : (
                        <>
                          {/* PayPal RÃ¼ckerstattung - nur wenn PayPal-Zahlung vorhanden */}
                          {order.zahlung?.methode === 'paypal' && order.zahlung?.paypalOrderId && (
                            <Button
                              size="small"
                              variant="contained"
                              sx={{ bgcolor: '#ff9800', '&:hover': { bgcolor: '#f57c00' } }}
                              startIcon={<Euro />}
                              onClick={async (e) => {
                                e.stopPropagation();
                                
                                const reason = prompt('Grund fÃ¼r PayPal-RÃ¼ckerstattung eingeben:') || 'Bestellung storniert';
                                
                                if (window.confirm(`PayPal-RÃ¼ckerstattung fÃ¼r ${order.bestellnummer} durchfÃ¼hren?\n\nBetrag: ${order.preise?.gesamtsumme}â‚¬\nGrund: ${reason}`)) {
                                  try {
                                    const response = await api.post(`/orders/${order._id}/paypal-refund`, {
                                      reason: reason,
                                      bearbeiter: 'Admin'
                                    });
                                    
                                    if (response.data.success) {
                                      setSuccess(`âœ… PayPal-RÃ¼ckerstattung erfolgreich: ${response.data.refund.refundId}`);
                                      loadOrders();
                                    } else {
                                      setError(`âŒ PayPal-RÃ¼ckerstattung fehlgeschlagen: ${response.data.message}`);
                                    }
                                  } catch (err) {
                                    console.error('PayPal-RÃ¼ckerstattung Fehler:', err);
                                    setError('âŒ Fehler bei PayPal-RÃ¼ckerstattung: ' + (err.response?.data?.message || err.message));
                                  }
                                }
                              }}
                            >
                              ðŸ’³ PayPal RÃ¼ckerstattung
                            </Button>
                          )}
                          
                          {/* PayPal Send Money - einfach und direkt */}
                          <Button
                            size="small"
                            variant="contained"
                            sx={{ bgcolor: '#0070ba', '&:hover': { bgcolor: '#005ea6' } }}
                            startIcon={<Euro />}
                            onClick={(e) => {
                              e.stopPropagation();
                              
                              // Kundendaten fÃ¼r RÃ¼ckerstattung
                              const amount = (order.preise?.gesamtsumme || 0).toFixed(2);
                              const email = order.besteller?.email || '';
                              const name = `${order.besteller?.vorname || ''} ${order.besteller?.nachname || ''}`.trim();
                              const orderNumber = order.bestellnummer || '';
                              
                              // Einfacher PayPal Send Money Link
                              const paypalUrl = `https://www.paypal.com/myaccount/transfer/send?recipient=${encodeURIComponent(email)}&amount=${amount}&currency=EUR&note=${encodeURIComponent(`RÃ¼ckerstattung GlÃ¼cksmomente.manufaktur - ${orderNumber}`)}`;
                              
                              // Anzeige fÃ¼r Admin mit allen notwendigen Daten
                              const confirmMessage = `PayPal-RÃ¼ckerstattung:\n\n` +
                                `EmpfÃ¤nger: ${email}\n` +
                                `Name: ${name}\n` +
                                `Betrag: ${amount} EUR\n` +
                                `Bestellung: ${orderNumber}\n` +
                                `Verwendungszweck: RÃ¼ckerstattung GlÃ¼cksmomente.manufaktur - ${orderNumber}\n\n` +
                                `PayPal wird geÃ¶ffnet. Nach erfolgreichem Versand bitte "RÃ¼ckerstattung bestÃ¤tigen" klicken.`;
                              
                              alert(confirmMessage);
                              window.open(paypalUrl, '_blank');
                            }}
                          >
                            ðŸ’° PayPal RÃ¼ckerstattung
                          </Button>
                          
                          {/* BestÃ¤tigung nach PayPal-Versand */}
                          <Button
                            size="small"
                            variant="outlined"
                            color="success"
                            startIcon={<Euro />}
                            onClick={async (e) => {
                              e.stopPropagation();
                              
                              const confirmSent = window.confirm(
                                `Haben Sie die PayPal-RÃ¼ckerstattung erfolgreich versendet?\n\n` +
                                `EmpfÃ¤nger: ${order.besteller?.email}\n` +
                                `Betrag: ${(order.preise?.gesamtsumme || 0).toFixed(2)} EUR\n` +
                                `Bestellung: ${order.bestellnummer}\n\n` +
                                `Die Bestellung wird als erledigt markiert.`
                              );
                              
                              if (!confirmSent) return;
                              
                              try {
                                const transactionId = prompt('Optional: PayPal Transaction ID eingeben:') || 'Manuell bestÃ¤tigt';
                                
                                // PayPal-RÃ¼ckerstattung Ã¼ber API bestÃ¤tigen
                                const response = await api.post(`/orders/${order._id}/paypal-refund-confirm`, {
                                  amount: order.preise?.gesamtsumme,
                                  transactionId: transactionId,
                                  bearbeiter: 'Admin'
                                });
                                
                                if (response.data.success) {
                                  setSuccess('âœ… PayPal-RÃ¼ckerstattung erfolgreich bestÃ¤tigt');
                                  loadOrders();
                                } else {
                                  setError(`âŒ Fehler: ${response.data.message}`);
                                }
                              } catch (err) {
                                console.error('RÃ¼ckerstattung-BestÃ¤tigung Fehler:', err);
                                setError('âŒ Fehler bei der BestÃ¤tigung: ' + (err.response?.data?.message || err.message));
                              }
                            }}
                          >
                            âœ“ RÃ¼ckerstattung bestÃ¤tigen
                          </Button>
                          
                          {/* Hinweis fÃ¼r manuellen Prozess */}
                          <Typography variant="caption" sx={{ 
                            display: 'block', 
                            mt: 1, 
                            p: 1, 
                            bgcolor: '#fff3e0', 
                            borderRadius: 1,
                            textAlign: 'center',
                            fontSize: '0.75rem'
                          }}>
                            ðŸ’¡ Nach erfolgreicher PayPal-RÃ¼ckerstattung wird die Bestellung automatisch als erledigt markiert
                          </Typography>
                        </>
                      )}
                      <Button
                        size="small"
                        variant="contained"
                        color="error"
                        startIcon={<Euro />}
                        onClick={(e) => {
                          e.stopPropagation();
                          setSelectedOrder(order);
                          setDialogOpen(true);
                        }}
                      >
                        Details anzeigen
                      </Button>
                    </Box>
                  )}
                  
                  {/* Tracking-Button nur fÃ¼r verpackte Bestellungen */}
                  {order.status === 'verpackt' && (
                    <Button
                      size="small"
                      variant="contained"
                      color="primary"
                      startIcon={<LocalShipping />}
                      onClick={(e) => {
                        e.stopPropagation();
                        setSelectedOrder(order);
                        setTrackingDialog(true);
                      }}
                    >
                      Tracking eingeben
                    </Button>
                  )}
                  
                  {/* Status-Aktions-Button fÃ¼r normale Bestellungen (nicht abgelehnt) */}
                  {order.status !== 'verschickt' && 
                   order.status !== 'zugestellt' && 
                   order.status !== 'storniert' && 
                   order.status !== 'abgelehnt' && (
                    <Button
                      size="small"
                      variant="contained"
                      color={order.status === 'bezahlt' ? 'success' : 'primary'}
                      onClick={(e) => {
                        e.stopPropagation();
                        const nextStatusMap = {
                          'neu': 'bestaetigt',
                          'bezahlt': 'bestaetigt', 
                          'bestaetigt': 'verpackt'
                        };
                        const nextStatus = nextStatusMap[order.status];
                        if (nextStatus) {
                          const actionText = {
                            'neu': 'BestÃ¤tigen',
                            'bezahlt': 'BestÃ¤tigen',
                            'bestaetigt': 'Als verpackt markieren'
                          };
                          handleStatusUpdate(order._id, nextStatus, `${actionText[order.status]} - ${new Date().toLocaleString('de-DE')}`);
                        }
                      }}
                    >
                      {order.status === 'bezahlt' ? 'âœ… BestÃ¤tigen' : 
                       order.status === 'bestaetigt' ? 'ðŸ“¦ Verpackt' : 
                       order.status === 'neu' ? 'âœ… BestÃ¤tigen' : 'Weiter'}
                    </Button>
                  )}

                  {/* Tracking anzeigen fÃ¼r verschickte Bestellungen */}
                  {order.versand?.sendungsnummer && (
                    <Button
                      size="small"
                      variant="outlined"
                      onClick={(e) => {
                        e.stopPropagation();
                        if (order.versand.trackingUrl) {
                          window.open(order.versand.trackingUrl, '_blank');
                        }
                      }}
                      disabled={!order.versand.trackingUrl}
                    >
                      ðŸ“¦ Tracking
                    </Button>
                  )}
                </Box>
              </CardContent>
            </Card>
          </Grid>
        );
      })}
    </Grid>
  );

  // Mobile-optimierte Compact Card View
  const MobileOrderCard = ({ order }) => {
    const daysSince = getDaysSinceLastStatusChange(order);
    
    // Keine rote Hervorhebung fÃ¼r rÃ¼ckerstattete oder abgeschlossene Bestellungen
    const shouldHighlight = daysSince > 3 && 
      !['rÃ¼ckerstattung', 'rueckerstattung', 'erledigt', 'zugestellt', 'abgelehnt'].includes(order.status?.toLowerCase());

    return (
      <Card 
        sx={{ 
          mb: 1, 
          cursor: 'pointer',
          backgroundColor: shouldHighlight ? 'rgba(244, 67, 54, 0.05)' : 'inherit',
          '&:hover': { backgroundColor: 'rgba(0, 0, 0, 0.04)' }
        }}
        onClick={() => {
          if (order.type === 'inquiry') {
            setSelectedInquiry(order);
            setInquiryDialogOpen(true);
          } else {
            setSelectedOrder(order);
            setDialogOpen(true);
          }
        }}
      >
        <CardContent sx={{ py: 1.5, '&:last-child': { pb: 1.5 } }}>
          <Box display="flex" justifyContent="space-between" alignItems="flex-start" mb={1}>
            <Box>
              <Typography variant="subtitle2" fontWeight="bold" color="primary">
                #{order.bestellnummer}
              </Typography>
              <Typography variant="body2" color="text.secondary">
                {order.besteller.vorname} {order.besteller.nachname}
              </Typography>
            </Box>
            <Box textAlign="right">
              <Typography variant="subtitle2" fontWeight="bold">
                {formatCurrency(order.preise?.gesamtsumme || 0)}
              </Typography>
              <Chip
                label={`${daysSince}d`}
                size="small"
                color={shouldHighlight && daysSince > 3 ? 'error' : daysSince > 1 ? 'warning' : 'success'}
              />
            </Box>
          </Box>
          
          <Box display="flex" justifyContent="space-between" alignItems="center">
            {getStatusChip(order.status)}
            <Box display="flex" gap={1} alignItems="center">
              <Typography variant="caption" color="text.secondary">
                {getNextAction(order)}
              </Typography>
              <IconButton
                size="small"
                onClick={(e) => {
                  e.stopPropagation();
                  setSelectedOrder(order);
                  setTrackingDialog(true);
                }}
                disabled={order.status === 'verschickt' || order.status === 'zugestellt'}
                sx={{ ml: 1 }}
              >
                <LocalShipping fontSize="small" />
              </IconButton>
            </Box>
          </Box>
        </CardContent>
      </Card>
    );
  };

  // Orders Table View (kompakt fÃ¼r viele Bestellungen)
  const OrdersTable = () => {
    const isMobile = useMediaQuery(theme.breakpoints.down('md'));
    
    // Mobile Ansicht: Compact Cards mit Pull-to-Refresh
    if (isMobile) {
      return (
        <Box
          sx={{
            overscrollBehavior: 'contain',
            touchAction: 'pan-y',
            position: 'relative'
          }}
          onTouchStart={(e) => {
            // Touch-Start Position fÃ¼r Pull-to-refresh
            if (window.scrollY <= 0) {
              e.currentTarget.dataset.touchStartY = e.touches[0].clientY;
            }
          }}
          onTouchMove={(e) => {
            // Pull-to-refresh Gesture
            if (window.scrollY <= 0 && e.currentTarget.dataset.touchStartY) {
              const touchStartY = parseFloat(e.currentTarget.dataset.touchStartY);
              const touchCurrentY = e.touches[0].clientY;
              const pullDistance = touchCurrentY - touchStartY;
              
              if (pullDistance > 100 && !refreshing) {
                e.currentTarget.style.transform = `translateY(${Math.min(pullDistance - 100, 50)}px)`;
                e.currentTarget.style.opacity = '0.8';
              }
            }
          }}
          onTouchEnd={(e) => {
            // Trigger refresh wenn genug gezogen wurde
            if (window.scrollY <= 0 && e.currentTarget.dataset.touchStartY) {
              const touchStartY = parseFloat(e.currentTarget.dataset.touchStartY);
              const touchEndY = e.changedTouches[0].clientY;
              const pullDistance = touchEndY - touchStartY;
              
              if (pullDistance > 120 && !refreshing) {
                handlePullToRefresh();
              }
              
              // Reset transform
              e.currentTarget.style.transform = '';
              e.currentTarget.style.opacity = '';
              delete e.currentTarget.dataset.touchStartY;
            }
          }}
        >
          {refreshing && (
            <Box display="flex" justifyContent="center" py={2}>
              <CircularProgress size={24} />
              <Typography variant="body2" sx={{ ml: 1 }}>
                Aktualisiere...
              </Typography>
            </Box>
          )}
          {combinedItems.map((order) => (
            <MobileOrderCard key={order._id} order={order} />
          ))}
        </Box>
      );
    }

    // Desktop Ansicht: VollstÃ¤ndige Tabelle
    return (
      <TableContainer component={Paper}>
        <Table size="small">
          <TableHead>
            <TableRow>
              <TableCell>Bestellnummer</TableCell>
              <TableCell>Status</TableCell>
              <TableCell>Kunde</TableCell>
              <TableCell>Betrag</TableCell>
              <TableCell>Letzte Ã„nderung</TableCell>
              <TableCell>NÃ¤chste Aktion</TableCell>
              <TableCell align="center">Aktionen</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {combinedItems.map((order) => {
              const daysSince = getDaysSinceLastStatusChange(order);
              
              // Keine rote Hervorhebung fÃ¼r rÃ¼ckerstattete oder abgeschlossene Bestellungen
              const shouldHighlight = daysSince > 3 && 
                !['rÃ¼ckerstattung', 'rueckerstattung', 'erledigt', 'zugestellt', 'abgelehnt'].includes(order.status?.toLowerCase());
              
              return (
                <TableRow
                  key={order._id}
                  hover
                  onClick={() => {
                    if (order.type === 'inquiry') {
                      setSelectedInquiry(order);
                      setInquiryDialogOpen(true);
                    } else {
                      setSelectedOrder(order);
                      setDialogOpen(true);
                    }
                  }}
                  sx={{
                    cursor: 'pointer',
                    backgroundColor: shouldHighlight ? 'rgba(244, 67, 54, 0.05)' : 'inherit'
                  }}
                >
                  <TableCell sx={{ fontWeight: 'bold' }}>
                    {order.bestellnummer}
                  </TableCell>
                  <TableCell>{getStatusChip(order.status)}</TableCell>
                  <TableCell>
                    {order.besteller.vorname} {order.besteller.nachname}
                    <br />
                    <Typography variant="caption" color="text.secondary">
                      {order.besteller.email}
                    </Typography>
                  </TableCell>
                  <TableCell sx={{ fontWeight: 'bold' }}>
                    {formatCurrency(order.preise?.gesamtsumme || 0)}
                  </TableCell>
                  <TableCell>
                    <Chip
                      label={`${daysSince}d`}
                      size="small"
                      color={shouldHighlight && daysSince > 3 ? 'error' : daysSince > 1 ? 'warning' : 'success'}
                    />
                  </TableCell>
                  <TableCell>
                    <Typography variant="body2" color="text.secondary">
                      {getNextAction(order)}
                    </Typography>
                  </TableCell>
                  <TableCell align="center">
                    <IconButton
                      size="small"
                      onClick={(e) => {
                        e.stopPropagation();
                        setSelectedOrder(order);
                        setTrackingDialog(true);
                      }}
                      disabled={order.status === 'verschickt' || order.status === 'zugestellt'}
                    >
                      <LocalShipping />
                    </IconButton>
                  </TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
      </TableContainer>
    );
  };

  // Dashboard View (Statistiken & Ãœbersicht)
  const OrdersDashboard = () => (
    <Grid container spacing={3}>
      {/* Statistik-Karten */}
      <Grid item xs={12}>
        <Grid container spacing={2}>
          {Object.entries(stats).map(([status, data]) => (
            <Grid item xs={12} sm={6} md={3} key={status}>
              <Card>
                <CardContent>
                  <Box display="flex" alignItems="center" justifyContent="space-between">
                    <Box>
                      <Typography variant="h4" color="primary">
                        {data.count}
                      </Typography>
                      <Typography variant="body2" color="text.secondary">
                        {statusConfig[status]?.label || status}
                      </Typography>
                    </Box>
                    <Typography variant="h6">
                      {formatCurrency(data.totalValue)}
                    </Typography>
                  </Box>
                </CardContent>
              </Card>
            </Grid>
          ))}
        </Grid>
      </Grid>

      {/* PrioritÃ¤ts-Listen */}
      <Grid item xs={12} md={6}>
        <Card>
          <CardContent>
            <Typography variant="h6" gutterBottom color="error">
              ðŸš¨ Dringende Bestellungen (&gt;3 Tage seit Bestellung)
            </Typography>
            <List dense>
              {combinedItems
                .filter(order => getOrderPriority(order) === 'high')
                .slice(0, 5)
                .map(order => (
                  <ListItem
                    key={order._id}
                    button
                    onClick={() => {
                      setSelectedOrder(order);
                      setDialogOpen(true);
                    }}
                  >
                    <ListItemIcon>
                      <Warning color="error" />
                    </ListItemIcon>
                    <ListItemText
                      primary={order.bestellnummer}
                      secondary={`${order.besteller.vorname} ${order.besteller.nachname} - ${formatCurrency(order.preise?.gesamtsumme || 0)}`}
                    />
                    <ListItemSecondaryAction>
                      {getStatusChip(order.status)}
                    </ListItemSecondaryAction>
                  </ListItem>
                ))
              }
            </List>
          </CardContent>
        </Card>
      </Grid>

      <Grid item xs={12} md={6}>
        <Card>
          <CardContent>
            <Typography variant="h6" gutterBottom color="primary">
            ðŸ’° HÃ¶chste Bestellwerte
            </Typography>
            <List dense>
              {combinedItems
                .sort((a, b) => (b.preise?.gesamtsumme || 0) - (a.preise?.gesamtsumme || 0))
                .slice(0, 5)
                .map(order => (
                  <ListItem
                    key={order._id}
                    button
                    onClick={() => {
                      setSelectedOrder(order);
                      setDialogOpen(true);
                    }}
                  >
                    <ListItemIcon>
                      <Euro color="primary" />
                    </ListItemIcon>
                    <ListItemText
                      primary={order.bestellnummer}
                      secondary={`${order.besteller.vorname} ${order.besteller.nachname}`}
                    />
                    <ListItemSecondaryAction>
                      <Typography variant="h6" color="primary">
                        {formatCurrency(order.preise?.gesamtsumme || 0)}
                      </Typography>
                    </ListItemSecondaryAction>
                  </ListItem>
                ))
              }
            </List>
          </CardContent>
        </Card>
      </Grid>
    </Grid>
  );

  return (
    <Container maxWidth="xl" sx={{ mt: { xs: 2, sm: 4 }, mb: 4, px: { xs: 1, sm: 3 } }}>
      {/* Header */}
      <Box 
        display="flex" 
        justifyContent="space-between" 
        alignItems="center" 
        mb={3}
        flexDirection={{ xs: 'column', sm: 'row' }}
        gap={{ xs: 2, sm: 0 }}
      >
        <Typography 
          variant={useMediaQuery(theme.breakpoints.down('sm')) ? 'h5' : 'h4'} 
          component="h1" 
          sx={{ fontWeight: 'bold' }}
        >
          ðŸ“¦ Bestellverwaltung
        </Typography>
        <Box display="flex" gap={2} alignItems="center" flexWrap="wrap">
          <Badge badgeContent={combinedItems.length} color="primary">
            <Chip
              label={`${combinedItems.length} Bestellungen + Anfragen`}
              color="primary" 
              variant="outlined"
              sx={{ fontWeight: 'bold' }}
              size={useMediaQuery(theme.breakpoints.down('sm')) ? 'small' : 'medium'}
            />
          </Badge>
          <IconButton 
            onClick={() => setHilfeOpen(true)}
            color="info"
            title="Hilfe zur Bestellverwaltung"
          >
            <HelpOutline />
          </IconButton>
          {loading && (
            <CircularProgress size={20} />
          )}
        </Box>
      </Box>

      {/* Filter-Leiste */}
      <Card sx={{ mb: 3 }}>
        <CardContent sx={{ py: { xs: 2, sm: 3 } }}>
          <Grid container spacing={2} alignItems="center">
            <Grid item xs={12} sm={6} md={3}>
              <FormControl fullWidth size="small">
                <InputLabel>Status Filter</InputLabel>
                <Select
                  value={filters.status}
                  label="Status Filter"
                  onChange={(e) => setFilters({ ...filters, status: e.target.value })}
                >
                  <MenuItem value="pending">ðŸ”„ Zu bearbeiten</MenuItem>
                  <MenuItem value="all">ðŸ“‹ Alle Bestellungen</MenuItem>
                  <MenuItem value="neu">â³ Neu</MenuItem>
                  <MenuItem value="bezahlt">ðŸ’° Bezahlt</MenuItem>
                  <MenuItem value="bestaetigt">âœ… BestÃ¤tigt</MenuItem>
                  <MenuItem value="abgelehnt">âŒ Abgelehnt</MenuItem>
                  <MenuItem value="verpackt">ðŸ“¦ Verpackt</MenuItem>
                  <MenuItem value="verschickt">ðŸšš Verschickt</MenuItem>
                  <MenuItem value="zugestellt">ðŸ  Zugestellt</MenuItem>
                </Select>
              </FormControl>
            </Grid>

            <Grid item xs={12} sm={6} md={2}>
              <FormControl fullWidth size="small">
                <InputLabel>Sortierung</InputLabel>
                <Select
                  value={filters.sortBy}
                  label="Sortierung"
                  onChange={(e) => setFilters({ ...filters, sortBy: e.target.value })}
                >
                  <MenuItem value="oldest">â° Ã„lteste zuerst</MenuItem>
                  <MenuItem value="newest">ðŸ†• Neueste zuerst</MenuItem>
                  <MenuItem value="value">ðŸ’° HÃ¶chster Wert</MenuItem>
                  <MenuItem value="status">ðŸ“Š Nach Status</MenuItem>
                </Select>
              </FormControl>
            </Grid>

            <Grid item xs={12} md={4}>
              <TextField
                fullWidth
                size="small"
                label="Erweiterte Suche"
                placeholder="Bestellnr, Kunde, E-Mail, Adresse, Artikel..."
                value={filters.searchTerm}
                onChange={(e) => setFilters({ ...filters, searchTerm: e.target.value })}
                InputProps={{
                  startAdornment: <Search sx={{ mr: 1, color: 'text.secondary' }} />
                }}
                helperText={filters.searchTerm ? `${combinedItems.length} Treffer` : 'Suche in allen Feldern'}
              />
            </Grid>

            <Grid item xs={12} md={3}>
              <Box display="flex" justifyContent={{ xs: 'center', md: 'flex-end' }} alignItems="center">
                <Typography variant="body2" color="text.secondary">
                  {combinedItems.length} EintrÃ¤ge gefunden
                </Typography>
              </Box>
            </Grid>
          </Grid>
        </CardContent>
      </Card>

      {/* View Tabs */}
      <Box sx={{ borderBottom: 1, borderColor: 'divider', mb: 3 }}>
        <Tabs 
          value={tabValue} 
          onChange={(e, newValue) => setTabValue(newValue)}
          variant={useMediaQuery(theme.breakpoints.down('sm')) ? 'fullWidth' : 'standard'}
          scrollButtons="auto"
        >
          <Tab 
            label={useMediaQuery(theme.breakpoints.down('sm')) ? "Karten" : "ðŸ“± Karten-Ansicht"} 
            icon={<ViewList />} 
            iconPosition={useMediaQuery(theme.breakpoints.down('sm')) ? 'top' : 'start'}
          />
          <Tab 
            label={useMediaQuery(theme.breakpoints.down('sm')) ? "Tabelle" : "ðŸ“Š Tabellen-Ansicht"} 
            icon={<Sort />} 
            iconPosition={useMediaQuery(theme.breakpoints.down('sm')) ? 'top' : 'start'}
          />
          <Tab 
            label={useMediaQuery(theme.breakpoints.down('sm')) ? "Dashboard" : "ðŸ“ˆ Dashboard"} 
            icon={<Dashboard />} 
            iconPosition={useMediaQuery(theme.breakpoints.down('sm')) ? 'top' : 'start'}
          />
        </Tabs>
      </Box>

      {/* Content */}
      {loading ? (
        <Box display="flex" justifyContent="center" alignItems="center" minHeight="300px">
          <CircularProgress />
        </Box>
      ) : error ? (
        <Alert severity="error" sx={{ mb: 3 }}>
          {error}
        </Alert>
      ) : (
        getTabContent()
      )}

      {/* Bestelldetails Dialog */}
      {selectedOrder && (
        <OrderDetailsDialog
          order={selectedOrder}
          open={dialogOpen}
          onClose={() => setDialogOpen(false)}
          onStatusUpdate={handleStatusUpdate}
          onConfirmOrder={handleConfirmOrder}
          onRejectOrder={handleRejectOrder}
          statusConfig={statusConfig}
          formatCurrency={formatCurrency}
          formatDate={formatDate}
          loading={loading}
          setSuccess={setSuccess}
          setError={setError}
          loadOrders={loadOrders}
          onEditTracking={(trackingData) => {
            setTrackingData(trackingData);
            setTrackingDialog(true);
          }}
        />
      )}

      {/* Anfrage Details Dialog */}
      {selectedInquiry && (
        <InquiryDetailsDialog
          inquiry={selectedInquiry}
          open={inquiryDialogOpen}
          onClose={() => setInquiryDialogOpen(false)}
          onApprove={(inquiry) => handleInquiryAction(inquiry, 'accept')}
          onReject={(inquiry) => handleInquiryAction(inquiry, 'reject')}
          onArchive={(inquiry) => handleInquiryAction(inquiry, 'archive')}
          formatDate={formatDate}
          loading={loading}
          setSuccess={setSuccess}
          setError={setError}
          loadOrders={loadInquiries}
        />
      )}

      {/* Tracking Dialog */}
      {selectedOrder && (
        <TrackingDialog
          open={trackingDialog}
          onClose={() => setTrackingDialog(false)}
          onSave={handleAddTracking}
          trackingData={trackingData}
          setTrackingData={setTrackingData}
          carrierOptions={carrierOptions}
          order={selectedOrder}
          validateTrackingNumber={validateTrackingNumber}
        />
      )}

      {/* Mobile FAB fÃ¼r schnelle Aktionen */}
      {useMediaQuery(theme.breakpoints.down('md')) && (
        <Box sx={{ position: 'fixed', bottom: 16, right: 16, zIndex: 1000 }}>
          <Fab
            color="primary"
            sx={{ mb: 1 }}
            onClick={handlePullToRefresh}
            size="small"
            disabled={refreshing}
          >
            {refreshing ? <CircularProgress size={20} color="inherit" /> : <Refresh />}
          </Fab>
          <br />
          <Fab
            color="secondary"
            onClick={() => {
              // Scroll to top fÃ¼r bessere Filter-Erreichbarkeit
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }}
            size="small"
          >
            <FilterList />
          </Fab>
        </Box>
      )}

      {/* Snackbar fÃ¼r Benachrichtigungen */}
      <Snackbar
        open={!!success}
        autoHideDuration={6000}
        onClose={() => setSuccess('')}
      >
        <Alert onClose={() => setSuccess('')} severity="success">
          {success}
        </Alert>
      </Snackbar>

      <Snackbar
        open={!!error}
        autoHideDuration={6000}
        onClose={() => setError('')}
      >
        <Alert onClose={() => setError('')} severity="error">
          {error}
        </Alert>
      </Snackbar>

      {/* Hilfe-Dialog */}
      <BestellverwaltungHilfe 
        open={hilfeOpen}
        onClose={() => setHilfeOpen(false)}
      />
    </Container>
  );
};

// Separate Komponenten fÃ¼r bessere Ãœbersicht
const OrderDetailsDialog = ({ order, open, onClose, onStatusUpdate, onConfirmOrder, onRejectOrder, statusConfig, formatCurrency, formatDate, loading, onMarkRefundCompleted, setSuccess, setError, loadOrders, onEditTracking }) => {
  const theme = useTheme();
  const [noteDialog, setNoteDialog] = useState(false);
  const [statusNote, setStatusNote] = useState('');
  const [newStatus, setNewStatus] = useState('');
  const [trackingNumber, setTrackingNumber] = useState('');
  const [trackingProvider, setTrackingProvider] = useState('dhl');
  
  // Rechnungs-State
  const [invoiceLoading, setInvoiceLoading] = useState(false);
  const [invoiceSending, setInvoiceSending] = useState(false);

  const handleStatusChange = (status) => {
    setNewStatus(status);
    if (status === 'verschickt') {
      setTrackingNumber('');
      setTrackingProvider('dhl');
    }
    setNoteDialog(true);
  };

  const confirmStatusUpdate = () => {
    let updateData = {
      status: newStatus,
      notiz: statusNote
    };

    // FÃ¼r "verschickt" Status: Tracking-Daten hinzufÃ¼gen
    if (newStatus === 'verschickt' && trackingNumber.trim()) {
      updateData.versand = {
        sendungsnummer: trackingNumber.trim(),
        anbieter: trackingProvider,
        versendetAm: new Date().toISOString(),
        trackingUrl: trackingProvider === 'dhl' 
          ? `https://www.dhl.de/de/privatkunden/pakete-empfangen/verfolgen.html?lang=de&idc=${trackingNumber.trim()}`
          : `https://www.google.com/search?q=${trackingNumber.trim()}+tracking`
      };
    }

    onStatusUpdate(order._id, newStatus, statusNote, updateData.versand);
    setNoteDialog(false);
    setStatusNote('');
    setNewStatus('');
    setTrackingNumber('');
    setTrackingProvider('dhl');
  };

  // ðŸ“„ RECHNUNGS-FUNKTIONEN
  const handleGenerateInvoice = async () => {
    setInvoiceLoading(true);
    try {
      const response = await fetch(`/api/orders/${order._id}/generate-invoice`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();
      
      if (data.success) {
        setSuccess(`Rechnung ${data.data.invoiceNumber} erfolgreich generiert`);
        // Bestellung neu laden um Rechnungsdaten zu aktualisieren
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else {
        setError('Fehler bei der Rechnungsgenerierung: ' + data.message);
      }
    } catch (error) {
      console.error('Fehler bei der Rechnungsgenerierung:', error);
      setError('Fehler bei der Rechnungsgenerierung');
    } finally {
      setInvoiceLoading(false);
    }
  };

  const handleSendInvoice = async () => {
    setInvoiceSending(true);
    try {
      const response = await fetch(`/api/orders/${order._id}/send-invoice`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();
      
      if (data.success) {
        setSuccess('Rechnung erfolgreich per E-Mail versendet');
        // Bestellung neu laden um E-Mail-Status zu aktualisieren
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else {
        setError('Fehler beim E-Mail-Versand: ' + data.message);
      }
    } catch (error) {
      console.error('Fehler beim E-Mail-Versand:', error);
      setError('Fehler beim E-Mail-Versand');
    } finally {
      setInvoiceSending(false);
    }
  };

  const handleDownloadInvoice = async () => {
    try {
      const response = await fetch(`/api/orders/${order._id}/invoice/download`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Rechnung-${order.invoiceNumber || order.bestellnummer}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        setSuccess('Rechnung-PDF heruntergeladen');
      } else {
        setError('Fehler beim PDF-Download');
      }
    } catch (error) {
      console.error('Fehler beim PDF-Download:', error);
      setError('Fehler beim PDF-Download');
    }
  };

  return (
    <>
      <Dialog 
        open={open} 
        onClose={onClose} 
        maxWidth="lg" 
        fullWidth
        fullScreen={useMediaQuery(theme.breakpoints.down('md'))}
        sx={{
          '& .MuiDialog-paper': {
            margin: { xs: 0, md: 2 },
            maxHeight: { xs: '100%', md: '90vh' }
          }
        }}
      >
        <DialogTitle>
          <Box display="flex" justifyContent="space-between" alignItems="center">
            <Typography variant="h6">
              ðŸ“‹ Bestellung {order.bestellnummer}
            </Typography>
            <Box display="flex" gap={1} alignItems="center">
              <Chip
                label={statusConfig[order.status]?.label || order.status}
                color={statusConfig[order.status]?.color || 'default'}
              />
              {useMediaQuery(theme.breakpoints.down('md')) && (
                <IconButton onClick={onClose} size="small">
                  <Cancel />
                </IconButton>
              )}
            </Box>
          </Box>
        </DialogTitle>
        
        <DialogContent dividers>
          <Grid container spacing={3}>
            {/* Kundendaten */}
            <Grid item xs={12} md={6}>
              <Card variant="outlined">
                <CardContent>
                  <Typography variant="h6" gutterBottom>
                    ðŸ‘¤ Kundendaten
                  </Typography>
                  <Typography><strong>Name:</strong> {order.besteller.vorname} {order.besteller.nachname}</Typography>
                  <Typography><strong>E-Mail:</strong> {order.besteller.email}</Typography>
                  {order.besteller.telefon && (
                    <Typography><strong>Telefon:</strong> {order.besteller.telefon}</Typography>
                  )}
                  <Typography><strong>Erstellt:</strong> {formatDate(order.erstelltAm)}</Typography>
                </CardContent>
              </Card>
            </Grid>

            {/* Bestellwert */}
            <Grid item xs={12} md={6}>
              <Card variant="outlined">
                <CardContent>
                  <Typography variant="h6" gutterBottom>
                    ðŸ’° Bestellwert
                  </Typography>
                  <Typography variant="h4" color="primary">
                    {formatCurrency(order.preise?.gesamtsumme || 0)}
                  </Typography>
                  {order.preise?.versand?.betrag > 0 && (
                    <Typography variant="body2">
                      (inkl. {formatCurrency(order.preise.versand.betrag)} Versand)
                    </Typography>
                  )}
                </CardContent>
              </Card>
            </Grid>

            {/* Artikel */}
            <Grid item xs={12}>
              <Card variant="outlined">
                <CardContent>
                  <Typography variant="h6" gutterBottom>
                    ðŸ›ï¸ Bestellte Artikel ({order.artikel?.length || 0})
                  </Typography>
                  
                  {/* Mobile optimierte Artikel-Liste */}
                  {useMediaQuery(theme.breakpoints.down('md')) ? (
                    // Mobile: Card-Layout ohne Tabelle
                    <Box>
                      {order.artikel?.map((item, index) => (
                        <Card key={index} variant="outlined" sx={{ mb: 2, p: 2 }}>
                          <Box display="flex" justifyContent="space-between" alignItems="flex-start" mb={1}>
                            <Box flex={1}>
                              <Typography variant="subtitle2" fontWeight="bold">
                                {item.produktSnapshot?.name || 'Unbekanntes Produkt'}
                              </Typography>
                              {item.produktSnapshot?.beschreibung && (
                                <Typography variant="caption" color="text.secondary" display="block">
                                  {typeof item.produktSnapshot.beschreibung === 'string' 
                                    ? item.produktSnapshot.beschreibung.substring(0, 100) + '...'
                                    : 'Produktbeschreibung'}
                                </Typography>
                              )}
                            </Box>
                          </Box>
                          <Box display="flex" justifyContent="space-between" alignItems="center">
                            <Typography variant="body2">
                              <strong>{item.menge}x</strong> Ã  {formatCurrency(item.einzelpreis)}
                            </Typography>
                            <Typography variant="h6" color="primary" fontWeight="bold">
                              {formatCurrency(item.gesamtpreis)}
                            </Typography>
                          </Box>
                        </Card>
                      ))}
                    </Box>
                  ) : (
                    // Desktop: Tabellen-Layout
                    <TableContainer>
                      <Table size="small">
                        <TableHead>
                          <TableRow>
                            <TableCell>Artikel</TableCell>
                            <TableCell align="center">Menge</TableCell>
                            <TableCell align="right">Einzelpreis</TableCell>
                            <TableCell align="right">Gesamtpreis</TableCell>
                          </TableRow>
                        </TableHead>
                        <TableBody>
                          {order.artikel?.map((item, index) => (
                            <TableRow key={index}>
                              <TableCell>
                                <Typography variant="body2" sx={{ fontWeight: 'medium' }}>
                                  {item.produktSnapshot?.name || 'Unbekanntes Produkt'}
                                </Typography>
                                {item.produktSnapshot?.beschreibung && (
                                  <Typography variant="caption" color="text.secondary">
                                    {typeof item.produktSnapshot.beschreibung === 'string' 
                                      ? item.produktSnapshot.beschreibung 
                                      : 'Produktbeschreibung'}
                                  </Typography>
                                )}
                              </TableCell>
                              <TableCell align="center">{item.menge}</TableCell>
                              <TableCell align="right">{formatCurrency(item.einzelpreis)}</TableCell>
                              <TableCell align="right" sx={{ fontWeight: 'bold' }}>
                                {formatCurrency(item.gesamtpreis)}
                              </TableCell>
                            </TableRow>
                          ))}
                        </TableBody>
                      </Table>
                    </TableContainer>
                  )}
                </CardContent>
              </Card>
            </Grid>

            {/* Versandinformationen */}
            <Grid item xs={12}>
              <Card variant="outlined">
                <CardContent>
                  <Typography variant="h6" gutterBottom>
                    ðŸšš Versandinformationen
                  </Typography>
                  
                  {/* PayPal RÃ¼ckerstattungs-Button fÃ¼r abgelehnte Bestellungen */}
                  {order.status === 'abgelehnt' && (
                    <Box mb={2} p={2} sx={{ bgcolor: '#e3f2fd', border: '1px solid #0070ba', borderRadius: 2 }}>
                      <Typography variant="body2" gutterBottom sx={{ fontWeight: 'bold', color: '#0070ba' }}>
                        ðŸ’³ RÃ¼ckerstattung erforderlich
                      </Typography>
                      <Typography variant="body2" sx={{ mb: 1 }}>
                        Betrag: <strong>{formatCurrency(order.preise?.gesamtsumme || 0)}</strong> an {order.besteller.email}
                      </Typography>
                      <Typography variant="body2" sx={{ mb: 2, fontSize: '0.85rem', color: '#666' }}>
                        Zahlungsmethode: {order.zahlung?.methode || 'Unbekannt'}
                      </Typography>
                      <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
                        <Button
                          variant="contained"
                          sx={{ bgcolor: '#0070ba', '&:hover': { bgcolor: '#005ea6' } }}
                          onClick={() => window.open('https://www.paypal.com/businessmanage/activities', '_blank')}
                          startIcon={<Euro />}
                          size="small"
                        >
                          PayPal Business Ã¶ffnen
                        </Button>
                        {!order.rueckerstattungErledigt && (
                          <Button
                            variant="outlined"
                            color="success"
                            onClick={async () => {
                              try {
                                const notiz = prompt('Optional: Notiz zur RÃ¼ckerstattung eingeben:') || '';
                                const response = await api.post(`/orders/${order._id}/refund-completed`, {
                                  notiz: notiz,
                                  bearbeiter: 'Admin'
                                });
                                if (response.data.success) {
                                  setSuccess('âœ… RÃ¼ckerstattung als erledigt markiert');
                                  loadOrders();
                                  onClose(); // Dialog schlieÃŸen
                                } else {
                                  setError(response.data.message);
                                }
                              } catch (err) {
                                setError('Fehler beim Markieren der RÃ¼ckerstattung');
                              }
                            }}
                            size="small"
                            sx={{ minWidth: 'auto' }}
                          >
                            âœ“ Erledigt
                          </Button>
                        )}
                      </Box>
                    </Box>
                  )}
                  
                  <Grid container spacing={2}>
                    <Grid item xs={12} md={6}>
                      <Typography><strong>Anbieter:</strong> {order.versand?.anbieter || 'Nicht gesetzt'}</Typography>
                      <Typography><strong>Methode:</strong> {order.versand?.methode || 'Standard'}</Typography>
                      {order.versand?.sendungsnummer && (
                        <Box display="flex" alignItems="center" gap={1}>
                          <Typography><strong>Sendungsnummer:</strong> {order.versand.sendungsnummer}</Typography>
                          <IconButton 
                            size="small" 
                            onClick={() => {
                              onEditTracking({
                                sendungsnummer: order.versand?.sendungsnummer || '',
                                anbieter: order.versand?.anbieter || 'dhl',
                                notiz: ''
                              });
                            }}
                            title="Tracking-Nummer bearbeiten"
                          >
                            <EditIcon fontSize="small" />
                          </IconButton>
                        </Box>
                      )}
                    </Grid>
                    <Grid item xs={12} md={6}>
                      {order.versand?.versendetAm && (
                        <Typography><strong>Versendet am:</strong> {formatDate(order.versand.versendetAm)}</Typography>
                      )}
                      {order.versand?.zugestelltAm && (
                        <Typography><strong>Zugestellt am:</strong> {formatDate(order.versand.zugestelltAm)}</Typography>
                      )}
                    </Grid>
                  </Grid>
                </CardContent>
              </Card>
            </Grid>

            {/* E-Mail-Kommunikation und RÃ¼ckerstattung */}
            {(order.kommunikation?.length > 0 || order.status === 'abgelehnt') && (
              <Grid item xs={12}>
                <Card variant="outlined">
                  <CardContent>
                    <Typography variant="h6" gutterBottom>
                      ðŸ“§ E-Mail-Kommunikation & RÃ¼ckerstattung
                    </Typography>
                    
                    {/* RÃ¼ckerstattungs-Info bei abgelehnten Bestellungen */}
                    {order.status === 'abgelehnt' && (
                      <Box mb={3} p={3} sx={{ bgcolor: '#ffebee', border: '2px solid #d32f2f', borderRadius: 2 }}>
                        <Typography variant="h6" gutterBottom sx={{ color: '#d32f2f', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: 1 }}>
                          ðŸ’° RÃœCKERSTATTUNG ERFORDERLICH
                        </Typography>
                        
                        <Grid container spacing={3}>
                          {/* Kundendaten */}
                          <Grid item xs={12} md={6}>
                            <Box p={2} sx={{ bgcolor: 'white', borderRadius: 1, border: '1px solid #ddd' }}>
                              <Typography variant="subtitle2" sx={{ fontWeight: 'bold', mb: 1, color: '#d32f2f' }}>
                                ðŸ‘¤ Kundendaten
                              </Typography>
                              <Typography variant="body2" sx={{ mb: 0.5 }}>
                                <strong>Name:</strong> {order.besteller.vorname} {order.besteller.nachname}
                              </Typography>
                              <Typography variant="body2" sx={{ mb: 0.5, wordBreak: 'break-all' }}>
                                <strong>E-Mail:</strong> {order.besteller.email}
                              </Typography>
                              <Typography variant="body2" sx={{ mb: 0.5 }}>
                                <strong>Telefon:</strong> {order.besteller.telefon || 'Nicht angegeben'}
                              </Typography>
                              {order.besteller.adresse && (
                                <Typography variant="body2" sx={{ fontSize: '0.85rem', color: 'text.secondary' }}>
                                  {order.besteller.adresse.strasse}, {order.besteller.adresse.plz} {order.besteller.adresse.stadt}
                                </Typography>
                              )}
                            </Box>
                          </Grid>

                          {/* RÃ¼ckerstattungsdetails */}
                          <Grid item xs={12} md={6}>
                            <Box p={2} sx={{ bgcolor: 'white', borderRadius: 1, border: '1px solid #ddd' }}>
                              <Typography variant="subtitle2" sx={{ fontWeight: 'bold', mb: 1, color: '#d32f2f' }}>
                                ðŸ’³ RÃ¼ckerstattungsdetails
                              </Typography>
                              <Typography variant="body1" sx={{ mb: 1, fontSize: '1.1rem', fontWeight: 'bold', color: '#d32f2f' }}>
                                <strong>Betrag:</strong> {formatCurrency(order.preise?.gesamtsumme || 0)}
                              </Typography>
                              <Typography variant="body2" sx={{ mb: 0.5 }}>
                                <strong>Zahlungsmethode:</strong> {order.zahlung?.methode?.toUpperCase() || 'UNBEKANNT'}
                              </Typography>
                              
                              {/* PayPal spezifische Infos */}
                              {order.zahlung?.methode === 'paypal' && (
                                <>
                                  <Typography variant="body2" sx={{ mb: 0.5, fontWeight: 'bold', color: '#0070ba' }}>
                                    ðŸ“§ PayPal E-Mail: {order.besteller.email}
                                  </Typography>
                                  {order.zahlung?.transactionId && (
                                    <Typography variant="body2" sx={{ mb: 0.5, fontFamily: 'monospace', fontSize: '0.8rem' }}>
                                      <strong>Transaction ID:</strong> {order.zahlung.transactionId}
                                    </Typography>
                                  )}
                                  {order.zahlung?.paypalOrderId && (
                                    <Typography variant="body2" sx={{ mb: 0.5, fontFamily: 'monospace', fontSize: '0.8rem' }}>
                                      <strong>PayPal Order ID:</strong> {order.zahlung.paypalOrderId}
                                    </Typography>
                                  )}
                                  
                                  {/* PayPal-RÃ¼ckerstattungsinformationen anzeigen */}
                                  {order.rueckerstattung && (
                                    <Box sx={{ mt: 2, p: 2, bgcolor: order.rueckerstattung.status === 'erfolgreich' ? '#e8f5e8' : '#ffe8e8', borderRadius: 1, border: '1px solid', borderColor: order.rueckerstattung.status === 'erfolgreich' ? 'success.main' : 'error.main' }}>
                                      <Typography variant="h6" sx={{ mb: 1, color: order.rueckerstattung.status === 'erfolgreich' ? 'success.main' : 'error.main' }}>
                                        ðŸ’° PayPal-RÃ¼ckerstattung
                                      </Typography>
                                      <Typography variant="body2" sx={{ mb: 0.5 }}>
                                        <strong>Status:</strong> {order.rueckerstattung.status}
                                      </Typography>
                                      {order.rueckerstattung.refundId && (
                                        <Typography variant="body2" sx={{ mb: 0.5, fontFamily: 'monospace', fontSize: '0.8rem' }}>
                                          <strong>Refund ID:</strong> {order.rueckerstattung.refundId}
                                        </Typography>
                                      )}
                                      {order.rueckerstattung.betrag && (
                                        <Typography variant="body2" sx={{ mb: 0.5 }}>
                                          <strong>Betrag:</strong> {order.rueckerstattung.betrag.value} {order.rueckerstattung.betrag.currency_code || 'EUR'}
                                        </Typography>
                                      )}
                                      <Typography variant="body2" sx={{ mb: 0.5 }}>
                                        <strong>Zeitpunkt:</strong> {new Date(order.rueckerstattung.zeitpunkt).toLocaleString('de-DE')}
                                      </Typography>
                                      <Typography variant="body2" sx={{ mb: 0.5 }}>
                                        <strong>Methode:</strong> {order.rueckerstattung.methode}
                                      </Typography>
                                      <Typography variant="body2" sx={{ mb: 0.5 }}>
                                        <strong>Bearbeiter:</strong> {order.rueckerstattung.bearbeiter}
                                      </Typography>
                                      {order.rueckerstattung.notiz && (
                                        <Typography variant="body2" sx={{ mb: 0.5 }}>
                                          <strong>Notiz:</strong> {order.rueckerstattung.notiz}
                                        </Typography>
                                      )}
                                      {order.rueckerstattung.fehler && (
                                        <Typography variant="body2" sx={{ mb: 0.5, color: 'error.main' }}>
                                          <strong>Fehler:</strong> {order.rueckerstattung.fehler}
                                        </Typography>
                                      )}
                                    </Box>
                                  )}
                                  
                                  <Typography variant="caption" sx={{ display: 'block', mt: 1, p: 1, bgcolor: '#e3f2fd', borderRadius: 1 }}>
                                    ðŸ’¡ <strong>PayPal-RÃ¼ckerstattung:</strong> Gehe zu PayPal Business â†’ AktivitÃ¤ten â†’ Transaction ID suchen â†’ "RÃ¼ckerstattung" klicken
                                  </Typography>
                                </>
                              )}

                              {/* Ãœberweisung spezifische Infos */}
                              {order.zahlung?.methode === 'ueberweisung' && (
                                <>
                                  <Typography variant="caption" sx={{ display: 'block', mt: 1, p: 1, bgcolor: '#fff3e0', borderRadius: 1 }}>
                                    ðŸ’¡ <strong>Ãœberweisung-RÃ¼ckerstattung:</strong> BankÃ¼berweisung an Kunde mit Referenz: {order.bestellnummer}
                                  </Typography>
                                </>
                              )}
                            </Box>
                          </Grid>
                          
                          {/* PayPal Send Money - vereinfacht */}
                          <Grid item xs={12}>
                            <Box display="flex" gap={2} justifyContent="center" mt={2} flexWrap="wrap">
                              <Button
                                variant="contained"
                                color="primary"
                                sx={{ bgcolor: '#0070ba', '&:hover': { bgcolor: '#005ea6' } }}
                                onClick={() => {
                                  const amount = (order.preise?.gesamtsumme || 0).toFixed(2);
                                  const email = order.besteller?.email || '';
                                  const name = `${order.besteller?.vorname || ''} ${order.besteller?.nachname || ''}`.trim();
                                  const orderNumber = order.bestellnummer || '';
                                  
                                  // Einfacher PayPal Send Money Link
                                  const paypalUrl = `https://www.paypal.com/myaccount/transfer/send?recipient=${encodeURIComponent(email)}&amount=${amount}&currency=EUR&note=${encodeURIComponent(`RÃ¼ckerstattung GlÃ¼cksmomente.manufaktur - ${orderNumber}`)}`;
                                  
                                  // Anzeige fÃ¼r Admin
                                  const confirmMessage = `PayPal-RÃ¼ckerstattung:\n\n` +
                                    `EmpfÃ¤nger: ${email}\n` +
                                    `Name: ${name}\n` +
                                    `Betrag: ${amount} EUR\n` +
                                    `Bestellung: ${orderNumber}\n\n` +
                                    `PayPal wird geÃ¶ffnet. Nach erfolgreichem Versand bitte bestÃ¤tigen.`;
                                  
                                  alert(confirmMessage);
                                  window.open(paypalUrl, '_blank');
                                }}
                                startIcon={<Euro />}
                              >
                                ðŸ’° PayPal RÃ¼ckerstattung
                              </Button>
                              
                              {/* BestÃ¤tigung nach PayPal-Versand */}
                              {order.rueckerstattung?.status !== 'erfolgreich' && (
                                <Button
                                  variant="outlined"
                                  color="success"
                                  startIcon={<Euro />}
                                  onClick={async () => {
                                    const confirmSent = window.confirm(
                                      `Haben Sie die PayPal-RÃ¼ckerstattung erfolgreich versendet?\n\n` +
                                      `EmpfÃ¤nger: ${order.besteller?.email}\n` +
                                      `Betrag: ${(order.preise?.gesamtsumme || 0).toFixed(2)} EUR\n` +
                                      `Bestellung: ${order.bestellnummer}\n\n` +
                                      `Die Bestellung wird als erledigt markiert.`
                                    );
                                    
                                    if (!confirmSent) return;
                                    
                                    try {
                                      const transactionId = prompt('Optional: PayPal Transaction ID eingeben:') || 'Manuell bestÃ¤tigt';
                                      
                                      const response = await api.post(`/orders/${order._id}/paypal-refund-confirm`, {
                                        amount: order.preise?.gesamtsumme,
                                        transactionId: transactionId,
                                        bearbeiter: 'Admin'
                                      });
                                      
                                      if (response.data.success) {
                                        setSuccess('âœ… PayPal-RÃ¼ckerstattung erfolgreich bestÃ¤tigt');
                                        loadOrders();
                                        onClose(); // Dialog schlieÃŸen
                                      } else {
                                        setError(`âŒ Fehler: ${response.data.message}`);
                                      }
                                    } catch (err) {
                                      setError('âŒ Fehler bei der BestÃ¤tigung: ' + (err.response?.data?.message || err.message));
                                    }
                                  }}
                                >
                                  âœ“ RÃ¼ckerstattung bestÃ¤tigen
                                </Button>
                              )}

                              <Button
                                variant="outlined"
                                color="error"
                                onClick={() => {
                                  const text = `RÃ¼ckerstattung fÃ¼r Bestellung ${order.bestellnummer}\nKunde: ${order.besteller.vorname} ${order.besteller.nachname}\nE-Mail: ${order.besteller.email}\nBetrag: ${formatCurrency(order.preise?.gesamtsumme || 0)}\nMethode: ${order.zahlung?.methode || 'Unbekannt'}${order.zahlung?.transactionId ? '\nTransaction ID: ' + order.zahlung.transactionId : ''}`;
                                  navigator.clipboard.writeText(text);
                                  // Kurze BestÃ¤tigung anzeigen
                                  const button = document.activeElement;
                                  const originalText = button.textContent;
                                  button.textContent = 'âœ… Kopiert!';
                                  setTimeout(() => {
                                    button.textContent = originalText;
                                  }, 2000);
                                }}
                                startIcon={<ContentCopy />}
                              >
                                Details kopieren
                              </Button>
                            </Box>
                          </Grid>
                        </Grid>
                      </Box>
                    )}
                    
                    {/* E-Mail-Historie */}
                    {order.kommunikation && order.kommunikation.length > 0 && (
                      <Box mt={3}>
                        <Typography variant="h6" gutterBottom>
                          ðŸ“§ E-Mail-Historie
                        </Typography>
                        <List dense>
                              {order.kommunikation
                                .filter(comm => comm.typ === 'email')
                                .sort((a, b) => new Date(b.zeitpunkt) - new Date(a.zeitpunkt))
                                .map((email, index) => (
                                  <ListItem key={index} divider>
                                    <ListItemIcon>
                                      <Email color={email.emailData?.status === 'gesendet' ? 'success' : 'default'} />
                                    </ListItemIcon>
                                    <ListItemText
                                      primary={
                                        <Box display="flex" alignItems="center" gap={1}>
                                          <Typography variant="body2" sx={{ fontWeight: 'bold' }}>
                                            {email.betreff}
                                          </Typography>
                                          <Chip
                                            label={email.emailData?.status || 'unbekannt'}
                                            size="small"
                                            color={email.emailData?.status === 'gesendet' ? 'success' : 'default'}
                                          />
                                        </Box>
                                      }
                                      secondary={
                                        <>
                                          <span style={{ display: 'block', color: theme.palette.text.secondary }}>
                                            {email.inhalt}
                                          </span>
                                          <span style={{ 
                                            display: 'block', 
                                            fontSize: '0.75rem',
                                            color: theme.palette.text.secondary 
                                          }}>
                                            An: {email.emailData?.empfaenger} | {formatDate(email.zeitpunkt)} | von {email.bearbeiter}
                                          </span>
                                          {email.emailData?.messageId && (
                                            <span style={{ 
                                              display: 'block', 
                                              fontSize: '0.75rem',
                                              color: theme.palette.text.secondary 
                                            }}>
                                              Message ID: {email.emailData.messageId}
                                            </span>
                                          )}
                                        </>
                                      }
                                    />
                                  </ListItem>
                                ))
                              }
                            </List>
                      </Box>
                    )}
                  </CardContent>
                </Card>
              </Grid>
            )}

            {/* ðŸ“„ RECHNUNGSINFORMATIONEN */}
                    {(order.invoiceNumber || order.rechnung?.nummer) && (
                      <Grid item xs={12} md={6}>
                        <Card variant="outlined">
                          <CardContent>
                            <Typography variant="h6" gutterBottom>
                              ðŸ“„ Rechnung
                            </Typography>
                            <Typography>
                              <strong>Rechnungsnummer:</strong> {order.invoiceNumber || order.rechnung?.nummer}
                            </Typography>
                            {(order.invoiceDate || order.rechnung?.datum) && (
                              <Typography>
                                <strong>Rechnungsdatum:</strong> {
                                  order.invoiceDate 
                                    ? formatDate(order.invoiceDate)
                                    : formatDate(order.rechnung.datum)
                                }
                              </Typography>
                            )}
                            <Typography>
                              <strong>E-Mail Status:</strong> {
                                (order.invoiceEmailSent || order.rechnung?.emailVersendet) 
                                  ? 'âœ… Versendet' 
                                  : 'âŒ Nicht versendet'
                              }
                            </Typography>
                            {(order.invoiceEmailSentAt || order.rechnung?.emailVersendetAm) && (
                              <Typography variant="body2" color="text.secondary">
                                Versendet am: {
                                  order.invoiceEmailSentAt 
                                    ? formatDate(order.invoiceEmailSentAt)
                                    : formatDate(order.rechnung.emailVersendetAm)
                                }
                              </Typography>
                            )}
                          </CardContent>
                        </Card>
                      </Grid>
                    )}

                    {/* Status-Verlauf */}
                    {order.statusVerlauf && order.statusVerlauf.length > 0 && (
                      <Grid item xs={12}>
                        <Card variant="outlined">
                          <CardContent>
                            <Typography variant="h6" gutterBottom>
                              ðŸ“ˆ Status-Verlauf
                            </Typography>
                            <List dense>
                              {order.statusVerlauf
                                .sort((a, b) => new Date(b.zeitpunkt) - new Date(a.zeitpunkt))
                                .map((entry, index) => (
                                  <ListItem key={index}>
                                    <ListItemIcon>
                                      <Timeline />
                                    </ListItemIcon>
                                    <ListItemText
                                      primary={
                                        <Box display="flex" alignItems="center" gap={1}>
                                          <Chip
                                            label={statusConfig[entry.status]?.label || entry.status}
                                            size="small"
                                            color={statusConfig[entry.status]?.color || 'default'}
                                          />
                                          <Typography variant="body2">
                                            {formatDate(entry.zeitpunkt)}
                                          </Typography>
                                        </Box>
                                      }
                                      secondary={
                                        <>
                                          {entry.notiz && (
                                            <span style={{ display: 'block' }}>{entry.notiz}</span>
                                          )}
                                          <span style={{ 
                                            fontSize: '0.75rem', 
                                            color: theme.palette.text.secondary 
                                          }}>
                                            von {entry.bearbeiter || 'System'}
                                          </span>
                                        </>
                                      }
                                    />
                                  </ListItem>
                                ))
                              }
                            </List>
                          </CardContent>
                        </Card>
                      </Grid>
                    )}
                    
                    {/* E-Mail-Historie */}
                    {order.kommunikation && order.kommunikation.length > 0 && (
                      <Box mt={3}>
                        <Typography variant="h6" gutterBottom>
                          ðŸ“§ E-Mail-Historie
                        </Typography>
                        <List dense>
                          {order.kommunikation
                            .filter(comm => comm.typ === 'email')
                            .sort((a, b) => new Date(b.zeitpunkt) - new Date(a.zeitpunkt))
                            .map((email, index) => (
                              <ListItem key={index} divider>
                                <ListItemIcon>
                                  <Email color={email.emailData?.status === 'gesendet' ? 'success' : 'default'} />
                                </ListItemIcon>
                                <ListItemText
                                  primary={
                                    <Box display="flex" alignItems="center" gap={1}>
                                      <Typography variant="body2" sx={{ fontWeight: 'bold' }}>
                                        {email.betreff}
                                      </Typography>
                                      <Chip
                                        label={email.emailData?.status || 'unbekannt'}
                                        size="small"
                                        color={email.emailData?.status === 'gesendet' ? 'success' : 'default'}
                                      />
                                    </Box>
                                  }
                                  secondary={
                                    <>
                                      <span style={{ display: 'block', color: theme.palette.text.secondary }}>
                                        {email.inhalt}
                                      </span>
                                      <span style={{ 
                                        display: 'block', 
                                        fontSize: '0.75rem',
                                        color: theme.palette.text.secondary 
                                      }}>
                                        An: {email.emailData?.empfaenger} | {formatDate(email.zeitpunkt)} | von {email.bearbeiter}
                                      </span>
                                      {email.emailData?.messageId && (
                                        <span style={{ 
                                          display: 'block', 
                                          fontSize: '0.75rem',
                                          color: theme.palette.text.secondary 
                                        }}>
                                          Message ID: {email.emailData.messageId}
                                        </span>
                                      )}
                                    </>
                                  }
                                />
                              </ListItem>
                            ))
                          }
                        </List>
                      </Box>
                    )}
                  </CardContent>
                </Card>
              </Grid>
            )}

            {/* ðŸ“„ RECHNUNGSINFORMATIONEN */}
                {(order.invoiceNumber || order.rechnung?.nummer) && (
                  <Grid item xs={12} md={6}>
                    <Card variant="outlined">
                      <CardContent>
                        <Typography variant="h6" gutterBottom>
                          ðŸ“„ Rechnung
                        </Typography>
                        <Typography>
                          <strong>Rechnungsnummer:</strong> {order.invoiceNumber || order.rechnung?.nummer}
                        </Typography>
                        {(order.invoiceDate || order.rechnung?.datum) && (
                          <Typography>
                            <strong>Rechnungsdatum:</strong> {
                              order.invoiceDate 
                                ? formatDate(order.invoiceDate)
                                : formatDate(order.rechnung.datum)
                            }
                          </Typography>
                        )}
                        <Typography>
                          <strong>E-Mail Status:</strong> {
                            (order.invoiceEmailSent || order.rechnung?.emailVersendet) 
                              ? 'âœ… Versendet' 
                              : 'âŒ Nicht versendet'
                          }
                        </Typography>
                        {(order.invoiceEmailSentAt || order.rechnung?.emailVersendetAm) && (
                          <Typography variant="body2" color="text.secondary">
                            Versendet am: {
                              order.invoiceEmailSentAt 
                                ? formatDate(order.invoiceEmailSentAt)
                                : formatDate(order.rechnung.emailVersendetAm)
                            }
                          </Typography>
                        )}
                      </CardContent>
                    </Card>
                  </Grid>
                )}

                {/* Status-Verlauf */}
                {order.statusVerlauf && order.statusVerlauf.length > 0 && (
                  <Grid item xs={12}>
                    <Card variant="outlined">
                      <CardContent>
                        <Typography variant="h6" gutterBottom>
                          ðŸ“ˆ Status-Verlauf
                        </Typography>
                        <List dense>
                          {order.statusVerlauf
                            .sort((a, b) => new Date(b.zeitpunkt) - new Date(a.zeitpunkt))
                            .map((entry, index) => (
                              <ListItem key={index}>
                                <ListItemIcon>
                                  <Timeline />
                                </ListItemIcon>
                                <ListItemText
                                  primary={
                                    <Box display="flex" alignItems="center" gap={1}>
                                      <Chip
                                        label={statusConfig[entry.status]?.label || entry.status}
                                        size="small"
                                        color={statusConfig[entry.status]?.color || 'default'}
                                      />
                                      <Typography variant="body2">
                                        {formatDate(entry.zeitpunkt)}
                                      </Typography>
                                    </Box>
                                  }
                                  secondary={
                                    <>
                                      {entry.notiz && (
                                        <span style={{ display: 'block' }}>{entry.notiz}</span>
                                      )}
                                      <span style={{ 
                                        fontSize: '0.75rem', 
                                        color: theme.palette.text.secondary 
                                      }}>
                                        von {entry.bearbeiter || 'System'}
                                      </span>
                                    </>
                                  }
                                />
                              </ListItem>
                            ))
                          }
                        </List>
                      </CardContent>
                    </Card>
                  </Grid>
                )}
              </Grid>
            </DialogContent>

            <DialogActions>
                  <Box display="flex" justifyContent="space-between" width="100%" p={1}>
                    <Box display="flex" gap={1}>
                      {/* Status-Aktionen */}
                      {order.status === 'neu' && (
                        <>
                          <Button
                            variant="contained"
                            color="success"
                            onClick={() => onConfirmOrder(order._id)}
                            disabled={loading}
                          >
                            âœ… BestÃ¤tigen & E-Mail
                          </Button>
                          <Button
                            variant="contained"
                            color="error"
                            onClick={() => onRejectOrder(order._id)}
                            disabled={loading}
                          >
                            âŒ Ablehnen & E-Mail
                          </Button>
                        </>
                      )}
                      {order.status === 'bezahlt' && (
                        <>
                          <Button
                            variant="contained"
                            color="success"
                            onClick={() => onConfirmOrder(order._id)}
                            disabled={loading}
                          >
                            âœ… BestÃ¤tigen & E-Mail
                          </Button>
                          <Button
                            variant="contained"
                            color="error"
                            onClick={() => onRejectOrder(order._id)}
                            disabled={loading}
                          >
                            âŒ Ablehnen & E-Mail
                          </Button>
                        </>
                      )}
                      {order.status === 'bestaetigt' && (
                        <Button
                          variant="contained"
                          color="warning"
                          onClick={() => handleStatusChange('verpackt')}
                        >
                          ðŸ“¦ Als verpackt markieren
                        </Button>
                      )}
                      {order.status === 'verpackt' && (
                        <Button
                          variant="contained"
                          color="secondary"
                          onClick={() => handleStatusChange('verschickt')}
                        >
                          ðŸšš Als verschickt markieren
                        </Button>
                      )}

                      {/* ðŸ“„ RECHNUNGS-AKTIONEN */}
                      {(order.status === 'bezahlt' || order.status === 'bestaetigt' || order.status === 'verpackt' || order.status === 'verschickt' || order.status === 'zugestellt') && (
                        <>
                          {!order.invoiceNumber && !order.rechnung?.nummer && (
                            <Button
                              variant="outlined"
                              color="primary"
                              startIcon={<InvoiceIcon />}
                              onClick={handleGenerateInvoice}
                              disabled={invoiceLoading}
                              size="small"
                            >
                              {invoiceLoading ? 'Generiere...' : 'Rechnung erstellen'}
                            </Button>
                          )}
                          
                          {(order.invoiceNumber || order.rechnung?.nummer) && (
                            <>
                              <Button
                                variant="outlined"
                                color="secondary"
                                startIcon={<DownloadIcon />}
                                onClick={handleDownloadInvoice}
                                size="small"
                              >
                                Rechnung-PDF
                              </Button>
                              
                              {(!order.invoiceEmailSent && !order.rechnung?.emailVersendet) && (
                                <Button
                                  variant="outlined"
                                  color="success"
                                  startIcon={<SendIcon />}
                                  onClick={handleSendInvoice}
                                  disabled={invoiceSending}
                                  size="small"
                                >
                                  {invoiceSending ? 'Sende...' : 'Per E-Mail'}
                                </Button>
                              )}
                              
                              {(order.invoiceEmailSent || order.rechnung?.emailVersendet) && (
                                <Chip
                                  icon={<EmailIcon />}
                                  label="Rechnung versendet"
                                  color="success"
                                  size="small"
                                  variant="outlined"
                                />
                              )}
                            </>
                          )}
                        </>
                      )}
                    </Box>

                    <Button onClick={onClose}>
                      SchlieÃŸen
                    </Button>
                  </Box>
                </DialogActions>
              </Dialog>

              {/* Status-Notiz Dialog */}
              <Dialog open={noteDialog} onClose={() => setNoteDialog(false)} maxWidth="sm" fullWidth>
                <DialogTitle>Status-Ã„nderung bestÃ¤tigen</DialogTitle>
                <DialogContent>
                  <Typography gutterBottom>
                    Status Ã¤ndern zu: <strong>{statusConfig[newStatus]?.label}</strong>
                  </Typography>

                  {/* Spezielle Felder fÃ¼r "verschickt" Status */}
                  {newStatus === 'verschickt' && (
                    <Box sx={{ mt: 3, mb: 2 }}>
                      <Typography variant="h6" gutterBottom color="primary">
                        ðŸ“¦ Versandinformationen (Pflichtangaben)
                      </Typography>
                      
                      <FormControl fullWidth sx={{ mb: 2 }}>
                        <InputLabel>Versanddienstleister</InputLabel>
                        <Select
                          value={trackingProvider}
                          label="Versanddienstleister"
                          onChange={(e) => setTrackingProvider(e.target.value)}
                        >
                          <MenuItem value="dhl">ðŸ“¦ DHL</MenuItem>
                          <MenuItem value="dpd">ðŸšš DPD</MenuItem>
                          <MenuItem value="hermes">ðŸ“® Hermes</MenuItem>
                          <MenuItem value="gls">ðŸš› GLS</MenuItem>
                          <MenuItem value="ups">ðŸ“¦ UPS</MenuItem>
                          <MenuItem value="other">ðŸª Sonstige</MenuItem>
                        </Select>
                      </FormControl>

                      <TextField
                        fullWidth
                        required
                        label="Sendungsnummer / Paketnummer"
                        value={trackingNumber}
                        onChange={(e) => setTrackingNumber(e.target.value)}
                        placeholder="z.B. 00340434161234567890"
                        helperText="Die Paketnummer ist fÃ¼r die Nachverfolgung erforderlich"
                        error={newStatus === 'verschickt' && trackingNumber.trim().length === 0}
                        sx={{ mb: 2 }}
                      />

                      <Alert severity="info" sx={{ mb: 2 }}>
                        <Typography variant="body2">
                          ðŸ’¡ <strong>Automatisch:</strong> Tracking-URL wird automatisch generiert und 
                          das Versanddatum auf heute gesetzt.
                        </Typography>
                      </Alert>
                    </Box>
                  )}

                  <TextField
                    fullWidth
                    multiline
                    rows={3}
                    label={newStatus === 'verschickt' ? "ZusÃ¤tzliche Notizen (optional)" : "Notiz (optional)"}
                    value={statusNote}
                    onChange={(e) => setStatusNote(e.target.value)}
                    placeholder="ZusÃ¤tzliche Informationen zur Status-Ã„nderung..."
                    sx={{ mt: 2 }}
                  />
                </DialogContent>
                <DialogActions>
                  <Button onClick={() => setNoteDialog(false)}>Abbrechen</Button>
                  <Button 
                    onClick={confirmStatusUpdate} 
                    variant="contained"
                    disabled={newStatus === 'verschickt' && trackingNumber.trim().length === 0}
                  >
                    {newStatus === 'verschickt' ? 'ðŸšš Als verschickt markieren' : 'Status Ã¤ndern'}
                  </Button>
                </DialogActions>
              </Dialog>
            </>
          );
        };

    const TrackingDialog = ({ open, onClose, onSave, trackingData, setTrackingData, carrierOptions, order, validateTrackingNumber }) => {
      // Live-Validierung der Sendungsnummer
      const validation = trackingData.sendungsnummer && trackingData.anbieter 
        ? validateTrackingNumber(trackingData.sendungsnummer, trackingData.anbieter)
        : null;

      // PrÃ¼fe, ob es sich um eine Bearbeitung handelt (existierende Sendungsnummer)
      const isEditing = order?.versand?.sendungsnummer;

      return (
        <Dialog open={open} onClose={onClose} maxWidth="sm" fullWidth>
          <DialogTitle>
            ðŸ“¦ {isEditing ? 'Tracking-Informationen bearbeiten' : 'Tracking-Informationen hinzufÃ¼gen'}
          </DialogTitle>
          <DialogContent dividers>
            <Box display="flex" flexDirection="column" gap={3} pt={1}>
          <Typography variant="body2" color="text.secondary">
            Bestellung: <strong>{order?.bestellnummer}</strong>
            {isEditing && (
              <Chip 
                label="Bearbeitung" 
                size="small" 
                color="warning" 
                sx={{ ml: 1 }} 
              />
            )}
          </Typography>

          <FormControl fullWidth>
            <InputLabel>Versanddienstleister</InputLabel>
            <Select
              value={trackingData.anbieter}
              onChange={(e) => setTrackingData({ ...trackingData, anbieter: e.target.value })}
              label="Versanddienstleister"
            >
              {carrierOptions.map(option => (
                <MenuItem key={option.value} value={option.value}>
                  {option.icon} {option.label}
                </MenuItem>
              ))}
            </Select>
          </FormControl>

          <Box>
            <TextField
              fullWidth
              label="Sendungsnummer"
              value={trackingData.sendungsnummer}
              onChange={(e) => setTrackingData({ ...trackingData, sendungsnummer: e.target.value })}
              placeholder={getPlaceholderForCarrier(trackingData.anbieter)}
              required
              error={validation && !validation.isValid}
              helperText={validation ? validation.message : getFormatHelpForCarrier(trackingData.anbieter)}
            />
          </Box>

          <TextField
            fullWidth
            multiline
            rows={2}
            label="Notiz (optional)"
            value={trackingData.notiz}
            onChange={(e) => setTrackingData({ ...trackingData, notiz: e.target.value })}
            placeholder="ZusÃ¤tzliche Versandhinweise..."
          />
        </Box>
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>
          Abbrechen
        </Button>
        <Button 
          onClick={onSave} 
          variant="contained"
          disabled={!trackingData.sendungsnummer || (validation && !validation.isValid)}
        >
          {isEditing ? 'Tracking aktualisieren' : 'Tracking hinzufÃ¼gen'}
        </Button>
      </DialogActions>
    </Dialog>
  );
};

// Hilfsfunktionen fÃ¼r Platzhalter und Format-Hilfen
const getPlaceholderForCarrier = (carrier) => {
  switch (carrier?.toLowerCase()) {
    case 'dhl': return 'z.B. 1234567890 oder JD123456789012';
    case 'gls': return 'z.B. 56T89AS2 oder 54478966532';
    case 'tnt': return 'z.B. 598846521';
    case 'dpd': return 'z.B. 1154565645 oder 12222335412365';
    case 'ups': return 'z.B. 1Z12345E1234567890';
    case 'hermes': return 'z.B. H1234567890';
    default: return 'Sendungsnummer eingeben';
  }
};

const getFormatHelpForCarrier = (carrier) => {
  switch (carrier?.toLowerCase()) {
    case 'dhl': return 'DHL: 10 Ziffern oder 2-3 Buchstaben + 12 Ziffern';
    case 'gls': return 'GLS: 8 Zeichen (gemischt) oder 11 Ziffern';
    case 'tnt': return 'TNT: 8 oder 9 Ziffern';
    case 'dpd': return 'DPD: 10-14 Ziffern, optional ein Buchstabe am Ende';
    case 'ups': return 'UPS: 1Z + 6 Zeichen + 8 Ziffern oder 9-18 Zeichen';
    case 'hermes': return 'Hermes: 8-16 Zeichen (Buchstaben und Ziffern)';
    default: return 'Sendungsnummer im korrekten Format eingeben';
  }
};

// Anfrage-Details Dialog
const InquiryDetailsDialog = ({ inquiry, open, onClose }) => {
  if (!inquiry) return null;

  const formatPrice = (price) => {
    return new Intl.NumberFormat('de-DE', {
      style: 'currency',
      currency: 'EUR'
    }).format(price);
  };

  const formatDate = (date) => {
    return new Date(date).toLocaleString('de-DE');
  };

  return (
    <Dialog open={open} onClose={onClose} maxWidth="md" fullWidth>
      <DialogTitle>
        Anfrage {inquiry.inquiryId}
        <Chip
          label="Anfrage"
          color="info"
          size="small"
          sx={{ ml: 2 }}
        />
      </DialogTitle>
      <DialogContent>
        <Grid container spacing={3}>
          {/* Kundendaten */}
          <Grid item xs={12} md={6}>
            <Typography variant="h6" gutterBottom>Kunde</Typography>
            <Typography variant="body2">
              <strong>Name:</strong> {inquiry.customer.name}
            </Typography>
            <Typography variant="body2">
              <strong>E-Mail:</strong> {inquiry.customer.email}
            </Typography>
            
            <Typography variant="h6" gutterBottom sx={{ mt: 2 }}>
              Rechnungsadresse
            </Typography>
            <Typography variant="body2">
              {inquiry.rechnungsadresse.vorname} {inquiry.rechnungsadresse.nachname}<br />
              {inquiry.rechnungsadresse.strasse} {inquiry.rechnungsadresse.hausnummer}<br />
              {inquiry.rechnungsadresse.plz} {inquiry.rechnungsadresse.stadt}
            </Typography>
          </Grid>

          {/* Artikel */}
          <Grid item xs={12} md={6}>
            <Typography variant="h6" gutterBottom>Artikel</Typography>
            <List dense>
              {inquiry.items.map((item, index) => (
                <ListItem key={index}>
                  <ListItemText
                    primary={`${item.quantity}x ${item.name}`}
                    secondary={formatPrice(item.price * item.quantity)}
                  />
                </ListItem>
              ))}
            </List>
            <Typography variant="body1" sx={{ mt: 1, fontWeight: 'bold' }}>
              Gesamtwert: {formatPrice(inquiry.total)}
            </Typography>
          </Grid>

          {/* Notizen */}
          {inquiry.customerNote && (
            <Grid item xs={12}>
              <Typography variant="h6" gutterBottom>Kundennotiz</Typography>
              <Typography variant="body2">
                {inquiry.customerNote}
              </Typography>
            </Grid>
          )}

          {/* Anfrage-Info */}
          <Grid item xs={12}>
            <Typography variant="body2" color="text.secondary">
              Anfrage erstellt: {formatDate(inquiry.createdAt)}
            </Typography>
          </Grid>
        </Grid>
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>
          SchlieÃŸen
        </Button>
        <Button 
          variant="contained" 
          color="success"
          onClick={() => {
            // Zur Anfragen-Verwaltung weiterleiten
            window.open(`/admin/anfragen`, '_blank');
          }}
        >
          In Anfragen-Verwaltung Ã¶ffnen
        </Button>
      </DialogActions>
    </Dialog>
  );
};

export default AdminOrdersManagement;